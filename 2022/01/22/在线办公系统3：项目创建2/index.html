<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|EB Garamond:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zodical416.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="轮回的叛逆太古老、过客忘不掉的每一场晚秋">
<meta property="og:type" content="article">
<meta property="og:title" content="办公系统 3. 项目创建及基础配置（二）">
<meta property="og:url" content="https://zodical416.github.io/2022/01/22/%E5%9C%A8%E7%BA%BF%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F3%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA2/index.html">
<meta property="og:site_name" content="Zodiacal">
<meta property="og:description" content="轮回的叛逆太古老、过客忘不掉的每一场晚秋">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121130325.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121131610.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121131752.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121131829.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121142531.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121163016.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121163959.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121164156.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220122212132.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220122212208.png">
<meta property="article:published_time" content="2022-01-22T13:48:15.773Z">
<meta property="article:modified_time" content="2022-01-29T14:23:48.394Z">
<meta property="article:author" content="Zodiacal">
<meta property="article:tag" content="项目实战">
<meta property="article:tag" content="小程序">
<meta property="article:tag" content="Spring Boot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220121130325.png">

<link rel="canonical" href="https://zodical416.github.io/2022/01/22/%E5%9C%A8%E7%BA%BF%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F3%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>办公系统 3. 项目创建及基础配置（二） | Zodiacal</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zodiacal</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zodical416.github.io/2022/01/22/%E5%9C%A8%E7%BA%BF%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F3%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zodiacal">
      <meta itemprop="description" content="引出魔鬼的一种试炼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zodiacal">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          办公系统 3. 项目创建及基础配置（二）
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-22 21:48:15" itemprop="dateCreated datePublished" datetime="2022-01-22T21:48:15+08:00">2022-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-29 22:23:48" itemprop="dateModified" datetime="2022-01-29T22:23:48+08:00">2022-01-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">办公系统</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>20 分钟</span>
            </span>
            <div class="post-description">轮回的叛逆太古老、过客忘不掉的每一场晚秋</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Shiro-和-JWT-技术"><a href="#Shiro-和-JWT-技术" class="headerlink" title="Shiro 和 JWT 技术"></a>Shiro 和 JWT 技术</h1><p>之前在配置 Swagger 时，为 Swagger 配置了对 JWT 技术的支持，即只要在 Swagger 页面上填写令牌字符串并让其保存，接下来在 Swagger 页面上执行任何 Web 方法，都会在请求头上附带令牌字符串。而后端项目处理该令牌字符串，就需要添加 Shiro 和 JWT 框架。</p>
<h2 id="Shior-简介"><a href="#Shior-简介" class="headerlink" title="Shior 简介"></a>Shior 简介</h2><p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220121130325.png"></p>
<p>Shiro是Java领域非常知名的认证（<code>Authentication</code>）与授权（<code>Authorization</code>）框架，用以替代JavaEE中的JAAS(Java 认证与授权服务)功能。相较于其他认证与授权框架，Shiro设计的非常简单，所以广受好评。任意JavaWeb项目都可以使用Shiro框架，而Spring Security必须要使用在Spring项目中。所以Shiro的适用性更加广泛。如<code>JFinal</code>和<code>Nutz</code>等非Spring框架都可以使用Shiro，而不能使用Spring Security框架。</p>
<h3 id="什么是认证？"><a href="#什么是认证？" class="headerlink" title="什么是认证？"></a>什么是认证？</h3><p>认证就是要核验用户的身份，比如说通过用户名和密码来检验用户的身份。说简单一些，认证就是登录。登录之后Shiro要记录用户成功登录的凭证。</p>
<h3 id="什么是授权？"><a href="#什么是授权？" class="headerlink" title="什么是授权？"></a>什么是授权？</h3><p>授权是比认证更加精细度的划分用户的行为。比如说一个教务管理系统中，学生登陆之后只能查看信息，不能修改信息。而班主任就可以修改学生的信息。这就是利用授权来限定不同身份用户的行为。</p>
<h3 id="Shiro靠什么做认证与授权的？"><a href="#Shiro靠什么做认证与授权的？" class="headerlink" title="Shiro靠什么做认证与授权的？"></a>Shiro靠什么做认证与授权的？</h3><p>Shiro可以利用<code>HttpSession</code>或者<code>Redis</code>存储用户的登录凭证，以及角色或者身份信息。然后利用过滤器（Filter），对每个Http请求过滤，检查请求对应的<code>HttpSession</code>或者<code>Redis</code>中的认证与授权信息。如果用户没有登陆，或者权限不够，那么Shiro会向客户端返回错误信息。</p>
<p>也就是说，在写用户登录模块的时候，用户登录成功之后，要调用Shiro保存登录凭证。然后查询用户的角色和权限，让Shiro存储起来。将来不管哪个方法需要登录访问，或者拥有特定的角色跟权限才能访问，只需要在方法前设置注解即可，非常简单。</p>
<h2 id="JWT-简介"><a href="#JWT-简介" class="headerlink" title="JWT 简介"></a>JWT 简介</h2><p>JWT（Json Web Token）, 是为了在网络应用环境间传递声明而执行的一种基于JSON的开放标准。JWT一般被用来在身份提供者和服务提供者间传递被认证的用户身份信息，以便于从资源服务器获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于认证，也可被加密。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220121131610.png"></p>
<h3 id="JWT-可以用在单点登录的系统中"><a href="#JWT-可以用在单点登录的系统中" class="headerlink" title="JWT 可以用在单点登录的系统中"></a>JWT 可以用在单点登录的系统中</h3><p>传统的<code>JavaWeb</code>项目，利用<code>HttpSession</code>保存用户的登陆凭证。如果后端系统采用了负载均衡设计，当用户在A节点成功登陆，那么登陆凭证保存在A节点的<code>HttpSession</code>中。如果用户下一个请求被负载均衡到了B节点，因为B节点上面没有用户的登陆凭证，就会需要用户重新登录，影响用户体验。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220121131752.png"></p>
<p>如果用户的登陆凭证经过加密（<code>Token</code>）保存在客户端，客户端每次提交请求的时候，把<code>Token</code>上传给后端服务器节点。即便后端项目使用了负载均衡，每个后端节点接收到客户端上传的<code>Token</code>之后，经过检测，是有效的<code>Token</code>，于是就断定用户已经成功登陆，接下来就可以提供后端服务了。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220121131829.png"></p>
<h3 id="JWT-兼容更多的客户端"><a href="#JWT-兼容更多的客户端" class="headerlink" title="JWT 兼容更多的客户端"></a>JWT 兼容更多的客户端</h3><p>传统的<code>HttpSession</code>依靠浏览器的<code>Cookie</code>存放<code>SessionId</code>，所以要求客户端必须是浏览器。现在的JavaWeb系统，客户端可以是浏览器、APP、小程序，以及物联网设备。为了让这些设备都能访问到JavaWeb项目，就必须要引入JWT技术。JWT的<code>Token</code>是纯字符串，至于客户端怎么保存，没有具体要求。只要客户端发起请求的时候，附带上<code>Token</code>即可。所以像物联网设备，我们可以用<code>SQLite</code>存储<code>Token</code>数据。</p>
<h1 id="创建-JwtUtil-工具类"><a href="#创建-JwtUtil-工具类" class="headerlink" title="创建 JwtUtil 工具类"></a>创建 JwtUtil 工具类</h1><p>应先从 JWT 做起，因为只有 JWT 先生成了令牌，才能用 Shiro 检查 JWT 是否合法。</p>
<p>JWT的<code>Token</code>要经过加密才能返回给客户端，而客户端上传的<code>Token</code>，后端项目也需要进行验证核实。于是我们需要一个JWT工具类，用来加密<code>Token</code>和验证<code>Token</code>的有效性。</p>
<h2 id="导入依赖库"><a href="#导入依赖库" class="headerlink" title="导入依赖库"></a>导入依赖库</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.10.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang3<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.httpcomponents<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>httpcore<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.13<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="定义密钥和过期时间"><a href="#定义密钥和过期时间" class="headerlink" title="定义密钥和过期时间"></a>定义密钥和过期时间</h2><p>先把密钥和过期时间定义到SpringBoot配置文件中，然后再值注入到JavaBean中。这样维护起来可以更加方便。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">emos:</span></span><br><span class="line">  <span class="attr">jwt:</span></span><br><span class="line">    <span class="comment">#密钥</span></span><br><span class="line">    <span class="attr">secret:</span> <span class="string">547815635Aa</span></span><br><span class="line">    <span class="comment">#令牌过期时间（天）（客户端）</span></span><br><span class="line">    <span class="attr">expire:</span>  <span class="number">5</span></span><br><span class="line">    <span class="comment">#令牌缓存时间（天数）,Redis 上令牌的保存天数</span></span><br><span class="line">    <span class="attr">cache-expire:</span> <span class="number">10</span></span><br></pre></td></tr></table></figure>

<h2 id="创建-JWT-工具类"><a href="#创建-JWT-工具类" class="headerlink" title="创建 JWT 工具类"></a>创建 JWT 工具类</h2><p>在<code>com.example.emos.wx.config.shiro</code>中创建<code>JwtUtil</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.emos.wx.config.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateField;</span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.date.DateUtil;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWT;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWTCreator;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.JWTVerifier;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.algorithms.Algorithm;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.interfaces.DecodedJWT;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">// Spring 框架所需注解</span></span><br><span class="line"><span class="meta">@Slf4j</span> <span class="comment">// 调用日志所需注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;emos.jwt.secret&#125;&quot;)</span> <span class="comment">// 值注入所需注解，注意是 Spring 框架下的 Value 注解，执行时会将该属性的数据注入到变量中</span></span><br><span class="line">    <span class="keyword">private</span> String secret; <span class="comment">// 密钥值</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;emos.jwt.expire&#125;&quot;)</span> <span class="comment">// 注入过期时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> expire;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据过期时间、密钥、userID生成令牌字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">creatToken</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        Date date = DateUtil.offset(<span class="keyword">new</span> Date(), DateField.DAY_OF_YEAR, <span class="number">5</span>); <span class="comment">// 将当前日期向后偏移5天做完 token 过期时间，将其保存在 Date 中</span></span><br><span class="line">        Algorithm algorithm = Algorithm.HMAC256(secret); <span class="comment">// 利用加密算法对密钥进行加密，传入的参数就是密钥</span></span><br><span class="line">        JWTCreator.Builder builder = JWT.create(); <span class="comment">// 创建内部类对象</span></span><br><span class="line">        <span class="comment">// 通过 builder 中的方法绑定 userID，设置过期时间和密钥的算法</span></span><br><span class="line">        String token = builder.withClaim(<span class="string">&quot;userId&quot;</span>, userId).withExpiresAt(date).sign(algorithm); <span class="comment">// 生成密钥</span></span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从令牌中获得 userId</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getUserId</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        DecodedJWT jwt = JWT.decode(token); <span class="comment">// 对令牌字符串进行解码</span></span><br><span class="line">        <span class="keyword">int</span> userId = jwt.getClaim(<span class="string">&quot;userId&quot;</span>).asInt(); <span class="comment">// 通过属性名反向得到 userId</span></span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 验证令牌字符串的有效性，该方法不返回数据，若验证失败则直接抛出异常</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifierToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        Algorithm algorithm = Algorithm.HMAC256(secret); <span class="comment">// 创建算法对象</span></span><br><span class="line">        JWTVerifier verifier = JWT.require(algorithm).build(); <span class="comment">// 创建验证对象，调用该对象中的方法即可验证令牌是否有效</span></span><br><span class="line">        verifier.verify(token); <span class="comment">// 调用验证方法，判断 token 是否是拿 secret 密钥进行验证的、是否过期了，若验证失败，验证方法直接抛出 Runtime 类型异常，不需要进行捕获，</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="把令牌封装为认证对象"><a href="#把令牌封装为认证对象" class="headerlink" title="把令牌封装为认证对象"></a>把令牌封装为认证对象</h1><p>需要把<code>JWT</code>和<code>Shiro</code>框架对接起来，这样<code>Shiro</code>框架就会拦截所有的Http请求，然后验证请求提交的<code>Token</code>是否有效。</p>
<p>后端项目获取令牌之后，不能直接交给<code>Shiro</code>框架做认证，而是必须先将令牌字符串封装成<code>Shiro</code>可以识别的认证对象才行，因此需要创建令牌的封装类。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220121142531.png"></p>
<p>客户端提交的<code>Token</code>不能直接交给<code>Shiro</code>框架，需要先封装成<code>AuthenticationToken</code>类型的对象，所以我们我们需要先创建<code>AuthenticationToken</code>的实现类。</p>
<p>在<code>com.example.emos.wx.config.shiro</code>中创建<code>OAuth2Token</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.emos.wx.config.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2Token</span> <span class="keyword">implements</span> <span class="title">AuthenticationToken</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String token; <span class="comment">// 定义变量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器对变量赋值</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OAuth2Token</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.token = token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 覆盖方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="创建-Oauth2Realm-类"><a href="#创建-Oauth2Realm-类" class="headerlink" title="创建 Oauth2Realm 类"></a>创建 Oauth2Realm 类</h1><p>创建用于认证与授权的 Realm 类，<code>OAuth2Realm</code>类是<code>AuthorizingRealm</code>的实现类，我们要在这个实现类中定义认证和授权的方法。因为认证与授权模块设计到用户模块和权限模块，但是目前还没有真正的开发业务模块，因此在这里先暂时定义空的认证去授权方法，把<code>Shiro</code>和<code>JWT</code>整合起来，在添加业务模块后再真正去实现认证与授权。</p>
<p>在<code>com.example.emos.wx.config.shiro</code>中创建<code>OAuth2Realm</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.emos.wx.config.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2Realm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// 通过该注解注入 JwtUtil 类型的对象，由于要覆盖认证方法，必然要处理令牌字符串，处理令牌字符串必然要用到 JwtUtil 工具类，因此要传入引用</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 做认证时需要让 Java Web 项目传入封装好的令牌对象，而非字符串，因此令牌封装类要传给这个 Realm 类。</span></span><br><span class="line"><span class="comment">     * 该方法就用于判断传入的封装好的令牌对象是否符合要求，即判断令牌对象是否属于所定义的 OAuth2Token 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token 传入的参数为接口类型的令牌对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 授权对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(AuthenticationToken token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> token <span class="keyword">instanceof</span> OAuth2Token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 授权方法，验证权限时调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> principalCollection</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 授权对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> </span>&#123;</span><br><span class="line">        SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo(); <span class="comment">// 创建授权对象</span></span><br><span class="line">        <span class="comment">// TODO 查询用户的权限列表</span></span><br><span class="line">        <span class="comment">// TODO 把权限列表添加到 info 对象中</span></span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 认证方法，登录时调用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authenticationToken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 认证对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> AuthenticationException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        <span class="comment">// TODO 从令牌中获取userId，然后检测该账户是否被冻结</span></span><br><span class="line">        SimpleAuthenticationInfo info = <span class="keyword">new</span> SimpleAuthenticationInfo(); <span class="comment">// 创建认证对象：若通过认证，则可以向 Shiro 框架返回一个认证对象，标记着用户已经成功登录了</span></span><br><span class="line">        <span class="comment">// TODO 向 info 对象中添加用户信息、Token 字符串</span></span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="令牌刷新机制设计"><a href="#令牌刷新机制设计" class="headerlink" title="令牌刷新机制设计"></a>令牌刷新机制设计</h1><h2 id="设置自动续期的令牌刷新机制"><a href="#设置自动续期的令牌刷新机制" class="headerlink" title="设置自动续期的令牌刷新机制"></a>设置自动续期的令牌刷新机制</h2><p>在定义JwtUtil工具类的时候，生成的Token都有过期时间。假设Token过期时间为15天，用户在第14天的时候，还可以免登录正常访问系统。但是到了第15天，用户的Token过期，于是用户需要重新登录系统。</p>
<p><code>HttpSession</code>的过期时间比较优雅，默认为15分钟。如果用户连续使用系统，只要间隔时间不超过15分钟，系统就不会销毁<code>HttpSession</code>对象。因此考虑 JWT 的令牌过期时间能不能做成<code>HttpSession</code>那样的超时过期方案，只要用户间隔操作时间不超过15天，系统就不需要用户重新登录系统，从而实现自动续期。实现这种效果的方案有两种：<code>双Token</code>方案和<code>Token缓存</code>方案。本项目采用<code>Token缓存</code>方案。 </p>
<p>由于 Redis 中的 Key 和 Value 是可以设置过期时间的，到期自动删除，因此 Token 缓存方案就把 Token 缓存到 Redis ，然后设置 Redis 里面缓存的 Token 过期时间为正常 Token 的2倍,然后根据情况刷新 Token 的过期时间。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220121163016.png"></p>
<h3 id="Token失效，缓存也不存在的情况"><a href="#Token失效，缓存也不存在的情况" class="headerlink" title="Token失效，缓存也不存在的情况"></a>Token失效，缓存也不存在的情况</h3><p>当第15天，用户的<code>Token</code>失效以后，我们让Shiro程序到Redis查看是否存在缓存的<code>Token</code>，如果这个<code>Token</code>不存在于Redis里面，就说明用户的操作间隔了15天，需要重新登录。</p>
<h3 id="Token失效，但是缓存还存在的情况"><a href="#Token失效，但是缓存还存在的情况" class="headerlink" title="Token失效，但是缓存还存在的情况"></a>Token失效，但是缓存还存在的情况</h3><p>如果Redis中存在缓存的<code>Token</code>，说明当前<code>Token</code>失效后，间隔时间还没有超过15天，不应该让用户重新登录。所以要生成新的<code>Token</code>返回给客户端，并且把这个<code>Token</code>缓存到Redis里面，这种操作成为刷新<code>Token</code>过期时间。</p>
<h2 id="客户端如何更新令牌"><a href="#客户端如何更新令牌" class="headerlink" title="客户端如何更新令牌"></a>客户端如何更新令牌</h2><p>服务端刷新Token过期时间，其实就是生成一个新的Token给客户端。那么客户端怎么知道这次响应带回来的Token是更新过的呢？这个问题很容易解决。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220121163959.png"></p>
<p>只要用户成功登陆系统，当后端服务器更新<code>Token</code>的时候，就在响应中添加<code>Token</code>。客户端那边判断每次Ajax响应里面是否包含<code>Token</code>，如果包含，就把<code>Token</code>保存起来就可以了。</p>
<h2 id="如何在响应中添加令牌"><a href="#如何在响应中添加令牌" class="headerlink" title="如何在响应中添加令牌"></a>如何在响应中添加令牌</h2><p>服务端生成新令牌，需要将其附加到响应中发给客户端。</p>
<p>创建的 Filter 类可以拦截请求与响应，因此可以将新生成的令牌添加到响应中返回给客户端。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220121164156.png"></p>
<p>我们定义<code>OAuth2Filter</code>类拦截所有的HTTP请求，一方面它会把请求中的<code>Token</code>字符串提取出来，封装成对象交给Shiro框架；另一方面，它会检查<code>Token</code>的有效性。如果<code>Token</code>过期，那么会生成新的<code>Token</code>，分别存储在<code>ThreadLocalToken</code>和Redis中。</p>
<blockquote>
<p>ThreadLocal是一个关于创建线程局部变量的类。<br>通常情况下，我们创建的变量是可以被任何一个线程访问并修改的。而使用ThreadLocal创建的变量只能被当前线程访问，其他线程则无法访问和修改。</p>
<p>在多线程条件下，若多个线程使用同一个对象的话，该对象中所保存的数据就会出现错乱，采用 ThreadLocal 相当于为每个线程配置了一个更新箱。未来该线程从 ThreadLocal 中提取数据，就是从更新箱中提取数据。每个线程都有一个更新箱，即便多个线程使用同一个 ThreadLocal 对象，也不会出现相互覆盖了。</p>
</blockquote>
<p>Filter 类放行请求之后，请求发送给 Controller 类中的 Web 方法执行，Web 方法会返回 R 对象。因此可以写一个 AoP 拦截器，拦截 Web 方法返回的 R 对象。拦截对象后，从 ThreadLocalToken 类中的 ThreadLocal 变量提取出刚才保存的令牌字符串，并将其绑定到 R 对象中，该对象就会被解析成 JSON 字符串返回给客户端，客户端即可提取出新生成的令牌字符串。因此可以说，ThreadLocalToken 类是负责在 Filter 和 TokenAspect 类之间传递数据的。</p>
<blockquote>
<p>Filter 和 Aspect 之间没有直接的调用关系，因此无法传递数据。因此需要将数据封装在第三方的对象中去。</p>
</blockquote>
<blockquote>
<p>不用 Filter 把新生成的令牌字符串直接写到拦截的响应中的原因：往响应中写数据需要借助于 IO 流，操作麻烦，因此创建媒介类和 AoP 切面类，通过拦截 Web 方法返回的 R 对象，往其中 put 数据就可以了。这样更加简单。</p>
</blockquote>
<h1 id="创建存储令牌的媒介类"><a href="#创建存储令牌的媒介类" class="headerlink" title="创建存储令牌的媒介类"></a>创建存储令牌的媒介类</h1><p>在<code>com.example.emos.wx.config.shiro</code>中创建<code>ThreadLocalToken</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.emos.wx.config.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span> <span class="comment">// 由于 Filter 类与 AOP 切面类都要使用，因此加入该注解，在 Spring 框架的其他 Java 类中就可以获得该媒介类的引用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalToken</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;String&gt; local = <span class="keyword">new</span> ThreadLocal&lt;&gt;(); <span class="comment">// 往 ThreadLocal 中保存刷新后的令牌</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * set get 方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        local.set(token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> local.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 清除绑定的数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        local.remove();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="创建-OAuth2Filter-类"><a href="#创建-OAuth2Filter-类" class="headerlink" title="创建 OAuth2Filter 类"></a>创建 OAuth2Filter 类</h1><p>在<code>com.example.emos.wx.config.shiro</code>中创建<code>OAuth2Filter</code>类。</p>
<p><strong>注意：</strong></p>
<p>因为在<code>OAuth2Filter</code>类中要读写<code>ThreadLocal</code>中的数据，所以<code>OAuth2Filter</code>类必须要设置成多例的，否则<code>ThreadLocal</code>将无法使用。</p>
<blockquote>
<p>单例对象：Spring 框架不管用多少次 Filter 类，都只创建一个对象，全局都使用这一个对象。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.emos.wx.config.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> cn.hutool.core.util.StrUtil;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.exceptions.JWTDecodeException;</span><br><span class="line"><span class="keyword">import</span> com.auth0.jwt.exceptions.TokenExpiredException;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.filter.authc.AuthenticatingFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Scope;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span> <span class="comment">// 设置为多例类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OAuth2Filter</span> <span class="keyword">extends</span> <span class="title">AuthenticatingFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// 持有媒介类的引用</span></span><br><span class="line">    <span class="keyword">private</span> ThreadLocalToken threadLocalToken; <span class="comment">// 实现媒介类</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;emos.jwt.cache-expire&#125;&quot;)</span><span class="comment">// 进行值注入，从而得到Redis中令牌的过期时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> cacheExpire;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtil jwtUtil; <span class="comment">// 校验令牌有效性时需要调用 JwtUtil 中的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;<span class="comment">// 该 Java 类中的方法生成的刷新后令牌，不仅要返回给客户端，还需要保存到 Redis 中，因此必须有 RedisTemplate 的引用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从请求中提取得到客户端的令牌</span></span><br><span class="line"><span class="comment">     * 接收的参数为 Http 请求</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getRequestToken</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String token = request.getHeader(<span class="string">&quot;token&quot;</span>); <span class="comment">// 请求头的参数名：token</span></span><br><span class="line">        <span class="comment">// 判断提取出的是否为空或空字符串，若是则尝试从请求体中提取 token</span></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isBlank(token)) &#123;</span><br><span class="line">            token = request.getParameter(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建 token，返回类型为令牌的封装类。</span></span><br><span class="line"><span class="comment">     * 客户端发出的每一个请求都会被拦截，拦截下来之后执行 createToken 方法，从请求头中获得 token，并将其封装为 token 对象，后续可将该对象传给 Shiro 框架</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationToken <span class="title">createToken</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 强制类型转换，转为 Http 类型的请求</span></span><br><span class="line">        HttpServletRequest req = (HttpServletRequest) request;</span><br><span class="line">        <span class="comment">// 调用私有方法，获得令牌</span></span><br><span class="line">        String token = getRequestToken(req);</span><br><span class="line">        <span class="comment">// 判断 token 是否为空，因为该方法返回类型必须为一个封装好的 token 对象，若为空则无法封装</span></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> OAuth2Token(token); <span class="comment">// 封装类是之前定义的</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *判断哪种请求是可以被 Shiro 框架所处理的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isAccessAllowed</span><span class="params">(ServletRequest request, ServletResponse response, Object mappedValue)</span> </span>&#123;</span><br><span class="line">        HttpServletRequest req = (HttpServletRequest) request; <span class="comment">// 类型转换</span></span><br><span class="line">        <span class="comment">// 判断请求类型是否为 options 类型的，若是则直接放行，否则交由 Shiro 处理</span></span><br><span class="line">        <span class="keyword">if</span>(req.getMethod().equals(RequestMethod.OPTIONS.name())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 若该请求是需要被 Shiro 框架所处理的，则进入该方法</span></span><br><span class="line"><span class="comment">     * 判断 token 是否过期、是否需要刷新，若刷新，则首先保存在 Redis 中，后保存在媒介类中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onAccessDenied</span><span class="params">(ServletRequest request, ServletResponse response)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HttpServletRequest req = (HttpServletRequest) request;</span><br><span class="line">        HttpServletResponse resp = (HttpServletResponse) response; <span class="comment">// 数据类型转换</span></span><br><span class="line">        <span class="comment">// 设置响应头：响应的字符集、响应的 name 类型以及跨域参数</span></span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        resp.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        resp.setHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        resp.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, req.getHeader(<span class="string">&quot;Origin&quot;</span>)); <span class="comment">// 允许跨域</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 清空 ThreadLocal 中的数据，因为一旦该方法判定令牌需要刷新，那么不光令牌要保存到 Redis 中，还要存入媒介类</span></span><br><span class="line">        threadLocalToken.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从请求头中获得 token 字符串</span></span><br><span class="line">        String token = getRequestToken(req);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(StrUtil.isBlank(token)) &#123;</span><br><span class="line">            resp.setStatus(HttpStatus.SC_UNAUTHORIZED); <span class="comment">//设置 http 状态码</span></span><br><span class="line">            resp.getWriter().print(<span class="string">&quot;无效的令牌&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 不为空则验证内容是否有效、是否过期</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jwtUtil.verifierToken(token); <span class="comment">// 若有问题则抛出异常，需要捕获异常判断是内容有问题还是已经过期</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (TokenExpiredException e) &#123; <span class="comment">// 抛出该异常代表令牌过期，后续需判断 Redis 中的令牌是否过期</span></span><br><span class="line">            <span class="keyword">if</span>(redisTemplate.hasKey(token)) &#123; <span class="comment">// 先判断 Redis 缓存中是否有该令牌数据，若有则表示客户端令牌过期，但是服务端未过期，进行令牌刷新</span></span><br><span class="line">                redisTemplate.delete(token);</span><br><span class="line">                <span class="keyword">int</span> userId = jwtUtil.getUserId(token);</span><br><span class="line">                token = jwtUtil.creatToken(userId); <span class="comment">// 生成新令牌</span></span><br><span class="line">                redisTemplate.opsForValue().set(token, userId + <span class="string">&quot;&quot;</span>, cacheExpire, TimeUnit.DAYS); <span class="comment">// 保存数据，key：token，value：userId（转为字符串），失效时间，时间单位</span></span><br><span class="line">                threadLocalToken.setToken(token); <span class="comment">// 保存到媒介类中一份</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resp.setStatus(HttpStatus.SC_UNAUTHORIZED); <span class="comment">//设置 http 状态码</span></span><br><span class="line">                resp.getWriter().print(<span class="string">&quot;令牌已过期&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JWTDecodeException e) &#123; <span class="comment">// 内容有问题</span></span><br><span class="line">            resp.setStatus(HttpStatus.SC_UNAUTHORIZED); <span class="comment">//设置 http 状态码</span></span><br><span class="line">            resp.getWriter().print(<span class="string">&quot;无效的令牌&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 令牌不存在问题，执行 Realm 类。</span></span><br><span class="line">        <span class="comment">// 无法直接调用，只能间接调用</span></span><br><span class="line">        <span class="keyword">boolean</span> bool = executeLogin(request, response); <span class="comment">// 返回成功或失败信息</span></span><br><span class="line">        <span class="keyword">return</span> bool;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Shiro 执行 Realm 类方法时，若认证失败，即用户没有登录或登录失败，就执行该方法，返回错误消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onLoginFailure</span><span class="params">(AuthenticationToken token, AuthenticationException e, ServletRequest request, ServletResponse response)</span> </span>&#123;</span><br><span class="line">        HttpServletRequest req = (HttpServletRequest) request;</span><br><span class="line">        HttpServletResponse resp = (HttpServletResponse) response; <span class="comment">// 数据类型转换</span></span><br><span class="line">        <span class="comment">// 设置响应头：响应的字符集、响应的 name 类型以及跨域参数</span></span><br><span class="line">        resp.setContentType(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">        resp.setCharacterEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        resp.setHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        resp.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, req.getHeader(<span class="string">&quot;Origin&quot;</span>)); <span class="comment">// 允许跨域</span></span><br><span class="line">        resp.setStatus(HttpStatus.SC_UNAUTHORIZED); <span class="comment">//设置 http 状态码</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            resp.getWriter().print(e.getMessage()); <span class="comment">// 返回认证失败的详细消息</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// 认证失败，返回 false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 掌管拦截请求与返回响应的方法，不需覆盖</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.doFilterInternal(request, response, chain);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="创建-ShiroConfig-类"><a href="#创建-ShiroConfig-类" class="headerlink" title="创建 ShiroConfig 类"></a>创建 ShiroConfig 类</h1><p>将之前创建的 Realm 类和 Filter 类配置到 Shiro 框架。需要注意，之前的 Filter 类不是标准意义上的 JavaWeb 中的过滤器 Java 类，只是一个普通的 JavaBean。若想让其能够拦截 Http 请求，就需要将其配置到 Shiro 框架。</p>
<p>要创建的 <code>ShiroConfig</code> 类，是用来把 <code>OAuth2Filter</code> 和 <code>OAuth2Realm</code> 配置到Shiro框架，这样所搭建的 Shiro+JWT 才算生效。</p>
<p>在 <code>com.example.emos.wx.config.shiro</code> 中创建 <code>ShiroConfig</code> 类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.emos.wx.config.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span> <span class="comment">// 替代 Spring 框架中 xml 文件的，属于配置性质，添加该注解</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所返回的对象需要封装之前创建的 Realm 类的对象，用于封装 Realm 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;securityManager&quot;)</span> <span class="comment">// 方法会被 Spring Boot 框架自动执行，该方法返回的对象就会直接注册给 SpringBoot 框架，用于将来自第三方库的对象交由 spring 管理</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">(OAuth2Realm realm)</span> </span>&#123;</span><br><span class="line">        DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager(); <span class="comment">// 构建子类对象</span></span><br><span class="line">        securityManager.setRealm(realm); <span class="comment">// 封装 Realm 对象</span></span><br><span class="line">        securityManager.setRememberMeManager(<span class="keyword">null</span>); <span class="comment">// 登陆凭证以令牌方式保存在客户端，服务端不保存登录凭证，因此是 null</span></span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用于封装过滤器对象、设置 Filter 拦截路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;shiroFilter&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shiroFilter</span><span class="params">(SecurityManager securityManager, OAuth2Filter filter)</span> </span>&#123;</span><br><span class="line">        ShiroFilterFactoryBean shiroFilter = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        shiroFilter.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 filter 类对象封装为 hashmap 对象，将 hashmap 传回给 factory bean</span></span><br><span class="line">        <span class="comment">// oauth 过滤</span></span><br><span class="line">        Map&lt;String, Filter&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;oauth2&quot;</span>, filter);</span><br><span class="line">        shiroFilter.setFilters(map); <span class="comment">// 将 map 传给 factory bean</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 定义 LinkedHashMap 对象，封装 key value 数据，设置需要拦截的路径请求与不需要拦截的路径请求</span></span><br><span class="line">        Map&lt;String, String&gt; filterMap = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">        <span class="comment">// 不需拦截的路径请求</span></span><br><span class="line">        filterMap.put(<span class="string">&quot;/webjars/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/druid/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/app/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/sys/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/swagger/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/v2/api-docs&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/swagger-ui.html&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/swagger-resources/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/captcha.jpg&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/user/register&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/user/login&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        filterMap.put(<span class="string">&quot;/test/**&quot;</span>, <span class="string">&quot;anon&quot;</span>);</span><br><span class="line">        <span class="comment">// 除上述路径之外都需要进行拦截</span></span><br><span class="line">        filterMap.put(<span class="string">&quot;/**&quot;</span>, <span class="string">&quot;oauth2&quot;</span>);</span><br><span class="line">        shiroFilter.setFilterChainDefinitionMap(filterMap); <span class="comment">// 将 linked hashmap 传给 factory bean</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 管理 Shiro 对象的生命周期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;lifecycleBeanPostProcessor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LifecycleBeanPostProcessor <span class="title">lifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AOP 切面类，拦截 web 方法的执行</span></span><br><span class="line"><span class="comment">     * 声明 web 方法时，可以给方法加权限验证注解，加注解后，该web方法在执行前就会被 AOP 切面类拦截，并验证是否满足权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean(&quot;authorizationAttributeSourceAdvisor&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span> </span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor advisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        advisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> advisor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="利用切面类向客户端返回新令牌"><a href="#利用切面类向客户端返回新令牌" class="headerlink" title="利用切面类向客户端返回新令牌"></a>利用切面类向客户端返回新令牌</h1><p>在写 <code>OAuth2Filter</code> 的时候，创建了一个媒介类，即把更新后的令牌写到 <code>ThreadLocalToken</code> 里面的 <code>ThreadLocal</code>。为了从媒介类中取得更新后的 <code>token</code>，因此需要创建AOP切面类，拦截所有Web方法的返回值，在返回的R对象中添加更新后的令牌，这样这个令牌才能被返回给客户端。</p>
<p>该切面类是一个环绕事件，即其既能拦截方法调用之前传入的参数，又可以拦截这个方法执行之后的返回值，而主要任务就是往这个返回值中添加新生成的令牌。</p>
<p>在<code>com.example.emos.wx.aop</code>中创建<code>TokenAspect</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.emos.wx.aop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.emos.wx.common.util.R;</span><br><span class="line"><span class="keyword">import</span> com.example.emos.wx.config.shiro.ThreadLocalToken;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Pointcut;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span> <span class="comment">// 切面类需加</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// 需要从媒介类中取数据，因此必须持有媒介类对象的引用</span></span><br><span class="line">    <span class="keyword">private</span> ThreadLocalToken threadLocalToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(public * com.example.emos.wx.controller.*.*(..)))</span><span class="string">&quot;) // 声明切点，即拦截哪些方法的调用：需要拦截 controller package 中所有的 java 类中的所有 web 方法，这些方法调用前后均被拦截</span></span><br><span class="line"><span class="string">    public void aspect() &#123;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    @Around(&quot;</span>aspect()<span class="string">&quot;) // 环绕事件，方法调用之前的参数可拦截，方法返回的结果也可拦截</span></span><br><span class="line"><span class="string">    public Object around(ProceedingJoinPoint point) throws Throwable&#123;</span></span><br><span class="line"><span class="string">        R r = (R)point.proceed(); // 获得拦截方法返回的结果，即 R 对象</span></span><br><span class="line"><span class="string">        // 检查有无新生成的令牌</span></span><br><span class="line"><span class="string">        String token = threadLocalToken.getToken();// 通过媒介类中的方法导出token</span></span><br><span class="line"><span class="string">        if(token != null) &#123;</span></span><br><span class="line"><span class="string">            r.put(&quot;</span>token<span class="string">&quot;, token);</span></span><br><span class="line"><span class="string">            threadLocalToken.clear(); // 清空媒介类</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">        return r;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="精简返回给客户端的异常数据"><a href="#精简返回给客户端的异常数据" class="headerlink" title="精简返回给客户端的异常数据"></a>精简返回给客户端的异常数据</h1><p>之前在测试sayHello()方法的时候，因为客户端提交的参数不正确，因此后端系统向客户端返回了大量的异常内容。因此需要对返回的异常内容做一下精简。</p>
<p>利用 Spring MVC 全局异常处理来精简。</p>
<p>@ControllerAdvice 可以全局捕获 Spring MVC 异常</p>
<p>在<code>com.example.emos.wx.config</code>中，创建<code>ExceptionAdvice</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.emos.wx.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.emos.wx.exception.EmosException;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.UnauthorizedException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.MethodArgumentNotValidException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j</span> <span class="comment">// 引用日志模块</span></span><br><span class="line"><span class="meta">@RestControllerAdvice</span> <span class="comment">// 捕获 SpringMVC 所抛出的各种异常，且后端项目使用 Restful 风格的调用，因此加上 Rest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ResponseBody</span> <span class="comment">// 方法返回的字符串，即错误消息，需要写入响应，因此必须加此注解</span></span><br><span class="line">    <span class="meta">@ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span> <span class="comment">// 规定响应的状态码，出现异常状态码为 500</span></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span> <span class="comment">// 加上该注解后方法才能全局捕获异常，括号内的内容说明，只要是 Exception 子类的异常就都可以捕获</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">validExceptionHandler</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">&quot;执行异常&quot;</span>, e);<span class="comment">// 遇到异常，首先通过日志模块输出异常</span></span><br><span class="line">        <span class="comment">// 判断异常的类型</span></span><br><span class="line">        <span class="comment">// 后端数据验证异常：精简异常内容</span></span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> MethodArgumentNotValidException) &#123;</span><br><span class="line">            MethodArgumentNotValidException exception = (MethodArgumentNotValidException) e; <span class="comment">// 数据类型强制转换</span></span><br><span class="line">            <span class="keyword">return</span> exception.getBindingResult().getFieldError().getDefaultMessage(); <span class="comment">// 提取异常中的消息，不用 get 方法是因为消息实在太多，需要调用对应的方法获取某些字段没有通过验证、原因是什么</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 自定义异常</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> EmosException) &#123;</span><br><span class="line">            <span class="comment">// 所定义的异常类本身就经过精简，因此只需要转换类型、返回数据即可</span></span><br><span class="line">            EmosException exception = (EmosException) e;</span><br><span class="line">            <span class="keyword">return</span> exception.getMsg();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 未授权异常：没有未登录异常的原因是因为，之前的 filter 类负责拦截请求，并从其中获得 token 字符串，并验证该字符串是否有效、是否过期，此时就会拦截未登录用户的请求</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> UnauthorizedException) &#123;</span><br><span class="line">            <span class="comment">// 若异常为非授权类型的，那么返回的错误消息需要经过进一步精简</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;您不具备相关权限&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 普通异常</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;后端执行异常&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动项目，切换至 Swagger 页面，观察精简后的异常消息。</p>
<p>name 数据设置为空：</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220122212132.png"></p>
<p>报错信息为精简后的错误消息：</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220122212208.png"></p>
<p>因为此时已经把 form 类中后端验证的注解拿掉了，因此此时 sayhello 方法没有后端验证的功能，该空数据在转义时报错，返回普通的 java 异常。</p>

      
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
      
    </div>


    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" rel="tag"># 项目实战</a>
              <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag"># 小程序</a>
              <a href="/tags/Spring-Boot/" rel="tag"># Spring Boot</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/01/20/%E5%9C%A8%E7%BA%BF%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F2%EF%BC%9A%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA/" rel="prev" title="办公系统 2. 项目创建及基础配置（一）">
      <i class="fa fa-chevron-left"></i> 办公系统 2. 项目创建及基础配置（一）
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/01/23/%E5%9C%A8%E7%BA%BF%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F4%EF%BC%9A%E5%88%A9%E7%94%A8UNI-APP%E5%88%9B%E5%BB%BA%E7%A7%BB%E5%8A%A8%E7%AB%AF%E9%A1%B9%E7%9B%AE/" rel="next" title="办公系统 4. 利用UNI-APP创建移动端项目">
      办公系统 4. 利用UNI-APP创建移动端项目 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Shiro-%E5%92%8C-JWT-%E6%8A%80%E6%9C%AF"><span class="nav-number">1.</span> <span class="nav-text">Shiro 和 JWT 技术</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Shior-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">Shior 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%AE%A4%E8%AF%81%EF%BC%9F"><span class="nav-number">1.1.1.</span> <span class="nav-text">什么是认证？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%8E%88%E6%9D%83%EF%BC%9F"><span class="nav-number">1.1.2.</span> <span class="nav-text">什么是授权？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shiro%E9%9D%A0%E4%BB%80%E4%B9%88%E5%81%9A%E8%AE%A4%E8%AF%81%E4%B8%8E%E6%8E%88%E6%9D%83%E7%9A%84%EF%BC%9F"><span class="nav-number">1.1.3.</span> <span class="nav-text">Shiro靠什么做认证与授权的？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JWT-%E7%AE%80%E4%BB%8B"><span class="nav-number">1.2.</span> <span class="nav-text">JWT 简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JWT-%E5%8F%AF%E4%BB%A5%E7%94%A8%E5%9C%A8%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E7%9A%84%E7%B3%BB%E7%BB%9F%E4%B8%AD"><span class="nav-number">1.2.1.</span> <span class="nav-text">JWT 可以用在单点登录的系统中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JWT-%E5%85%BC%E5%AE%B9%E6%9B%B4%E5%A4%9A%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="nav-number">1.2.2.</span> <span class="nav-text">JWT 兼容更多的客户端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-JwtUtil-%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-number">2.</span> <span class="nav-text">创建 JwtUtil 工具类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="nav-number">2.1.</span> <span class="nav-text">导入依赖库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89%E5%AF%86%E9%92%A5%E5%92%8C%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="nav-number">2.2.</span> <span class="nav-text">定义密钥和过期时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-JWT-%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="nav-number">2.3.</span> <span class="nav-text">创建 JWT 工具类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8A%8A%E4%BB%A4%E7%89%8C%E5%B0%81%E8%A3%85%E4%B8%BA%E8%AE%A4%E8%AF%81%E5%AF%B9%E8%B1%A1"><span class="nav-number">3.</span> <span class="nav-text">把令牌封装为认证对象</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-Oauth2Realm-%E7%B1%BB"><span class="nav-number">4.</span> <span class="nav-text">创建 Oauth2Realm 类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%A4%E7%89%8C%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6%E8%AE%BE%E8%AE%A1"><span class="nav-number">5.</span> <span class="nav-text">令牌刷新机制设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E8%87%AA%E5%8A%A8%E7%BB%AD%E6%9C%9F%E7%9A%84%E4%BB%A4%E7%89%8C%E5%88%B7%E6%96%B0%E6%9C%BA%E5%88%B6"><span class="nav-number">5.1.</span> <span class="nav-text">设置自动续期的令牌刷新机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Token%E5%A4%B1%E6%95%88%EF%BC%8C%E7%BC%93%E5%AD%98%E4%B9%9F%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">5.1.1.</span> <span class="nav-text">Token失效，缓存也不存在的情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Token%E5%A4%B1%E6%95%88%EF%BC%8C%E4%BD%86%E6%98%AF%E7%BC%93%E5%AD%98%E8%BF%98%E5%AD%98%E5%9C%A8%E7%9A%84%E6%83%85%E5%86%B5"><span class="nav-number">5.1.2.</span> <span class="nav-text">Token失效，但是缓存还存在的情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E6%9B%B4%E6%96%B0%E4%BB%A4%E7%89%8C"><span class="nav-number">5.2.</span> <span class="nav-text">客户端如何更新令牌</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E5%9C%A8%E5%93%8D%E5%BA%94%E4%B8%AD%E6%B7%BB%E5%8A%A0%E4%BB%A4%E7%89%8C"><span class="nav-number">5.3.</span> <span class="nav-text">如何在响应中添加令牌</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E4%BB%A4%E7%89%8C%E7%9A%84%E5%AA%92%E4%BB%8B%E7%B1%BB"><span class="nav-number">6.</span> <span class="nav-text">创建存储令牌的媒介类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-OAuth2Filter-%E7%B1%BB"><span class="nav-number">7.</span> <span class="nav-text">创建 OAuth2Filter 类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-ShiroConfig-%E7%B1%BB"><span class="nav-number">8.</span> <span class="nav-text">创建 ShiroConfig 类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%88%87%E9%9D%A2%E7%B1%BB%E5%90%91%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%94%E5%9B%9E%E6%96%B0%E4%BB%A4%E7%89%8C"><span class="nav-number">9.</span> <span class="nav-text">利用切面类向客户端返回新令牌</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%B2%BE%E7%AE%80%E8%BF%94%E5%9B%9E%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%9A%84%E5%BC%82%E5%B8%B8%E6%95%B0%E6%8D%AE"><span class="nav-number">10.</span> <span class="nav-text">精简返回给客户端的异常数据</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zodiacal</p>
  <div class="site-description" itemprop="description">引出魔鬼的一种试炼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zodiacal</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">483k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:19</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
