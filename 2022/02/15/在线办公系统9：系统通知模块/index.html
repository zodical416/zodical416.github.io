<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|EB Garamond:300,300italic,400,400italic,700,700italic|Source Code Pro:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zodical416.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":false,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="我就像喝多了酒，十八岁的忧愁">
<meta property="og:type" content="article">
<meta property="og:title" content="办公系统 9. 系统通知模块">
<meta property="og:url" content="https://zodical416.github.io/2022/02/15/%E5%9C%A8%E7%BA%BF%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F9%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%E6%A8%A1%E5%9D%97/index.html">
<meta property="og:site_name" content="Zodiacal">
<meta property="og:description" content="我就像喝多了酒，十八岁的忧愁">
<meta property="og:locale">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206193033.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206194111.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206195107.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206195258.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206195423.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206200053.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206202953.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206203312.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206204620.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206204725.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206203633.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206203653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206203715.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206203738.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206203801.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206205419.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206212342.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206212402.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206214111.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220207154636.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220207163505.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220207172512.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220207173523.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220208163915.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220209111826.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220209145528.png">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/2cb842b2d49c358fb9b68005ac65ccf.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/14d530d1fe11968cffb4ee6e0dc3017.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220215150524.png">
<meta property="article:published_time" content="2022-02-15T07:08:00.437Z">
<meta property="article:modified_time" content="2022-02-15T07:08:02.826Z">
<meta property="article:author" content="Zodiacal">
<meta property="article:tag" content="项目实战">
<meta property="article:tag" content="小程序">
<meta property="article:tag" content="Spring Boot">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/zodical416/picto/master/20220206193033.png">

<link rel="canonical" href="https://zodical416.github.io/2022/02/15/%E5%9C%A8%E7%BA%BF%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F9%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%E6%A8%A1%E5%9D%97/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>办公系统 9. 系统通知模块 | Zodiacal</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Zodiacal</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://zodical416.github.io/2022/02/15/%E5%9C%A8%E7%BA%BF%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F9%EF%BC%9A%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zodiacal">
      <meta itemprop="description" content="引出魔鬼的一种试炼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zodiacal">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          办公系统 9. 系统通知模块
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-02-15 15:08:00 / 修改时间：15:08:02" itemprop="dateCreated datePublished" datetime="2022-02-15T15:08:00+08:00">2022-02-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8A%9E%E5%85%AC%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">办公系统</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>29k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>26 分钟</span>
            </span>
            <div class="post-description">我就像喝多了酒，十八岁的忧愁</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="消息通知模块基本设计原理"><a href="#消息通知模块基本设计原理" class="headerlink" title="消息通知模块基本设计原理"></a>消息通知模块基本设计原理</h1><h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><p><strong>公告消息记录应该全局唯一，还是为每个用户创建一条公告消息？</strong></p>
<p>这个问题取决于对系统消息的理解，如果不希望系统记录用户是否阅读了某条消息、哪些消息是未读消息，那么一个公告消息在数据表中就是一条唯一的记录，存储起来非常节省空间。但是很少有系统会这么设计，如果系统消息很多，又不告诉用户哪些是已读消息，哪些是未读消息，就会造成用户体验非常不好。所以系统必须要记录下来用户阅读了哪些消息，还有哪些消息是未读的。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206193033.png"></p>
<p><strong>用MongoDB存储消息数据</strong></p>
<p>因为消息模块的要存储的数据量太大，普通MySQL单表超过2000万记录，MySQL数据库就难以支撑，所以我们要换能存储海量数据的数据库产品,而 MongoDB 适合存储这样的海量低价值的数据，正好符合消息模块的存储要求。</p>
<p>即便MongoDB能存储TB级别的数据，但是消息数据日积月累，MongoDB也会有撑不下来的时候，那该怎么办呢？</p>
<ol>
<li><p>冷热数据分离，热数据定期归档</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206194111.png"></p>
<p>根据数据被使用的频率，可以划分成热数据和冷数据。一年内的数据被看做是热数据，超过一年的数据被当做冷数据。可以编写定时程序，在每天凌晨的时候把冷数据从MongoDB_1转移到另一个MongoDB_2。这样MongoDB_1的数据量减小了，因此CRUD的速度变快了。MongoDB_2存放的是冷数据，即便数据量很大，但是冷数据很少被用到，所以MongoDB_2仅仅充当归档库而已。</p>
</li>
<li><p>定期销毁冷数据，释放存储空间</p>
<p>归档库存储的冷数据太多，也难免出现崩溃，所以可以定期删除超期的冷数据。假设五年以上的冷数据就被当成是超期数据，删除超期数据之后，归档库的空间也就腾出来了。</p>
</li>
</ol>
<h2 id="系统消息的发送与收取"><a href="#系统消息的发送与收取" class="headerlink" title="系统消息的发送与收取"></a>系统消息的发送与收取</h2><p>一个大型Web系统，发送一条公告消息要往数据库里面写入大量的数据，即便MongoDB也支撑不下来瞬时写入百万、千万记录的情况，此时可以引入消息队列MQ，然后在Java后端系统上面，用异步多线程的方法，向消息队列MQ中发送消息，这样Web系统发布公告消息的时候就不占用数据库正常的CRUD操作。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206195107.png"></p>
<p>系统消息通过消息队列来进行发送，我们只是用它来做削峰填谷，其最终还是要存储在数据库上面。因此整个系统可以设计为：在用户登录系统的时候，用异步线程从消息队列MQ中，接收该用户的系统消息，然后把系统消息存储在数据库中，最后消息队列MQ中的该条消息自动删除。由于不可能所有用户同时登陆Web系统，所以我们就把往数据库中写入系统消息的任务，变成了错峰写入。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206195258.png"></p>
<h2 id="业务说明"><a href="#业务说明" class="headerlink" title="业务说明"></a>业务说明</h2><p>需要消息模块的具体业务说明</p>
<h3 id="系统登录"><a href="#系统登录" class="headerlink" title="系统登录"></a>系统登录</h3><p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206195423.png"></p>
<p>用户登录系统的时候，后端Emos系统要创建异步线程，接收消息队列MQ中的消息，然后把消息写到数据库里面。</p>
<h3 id="首页定时轮询"><a href="#首页定时轮询" class="headerlink" title="首页定时轮询"></a>首页定时轮询</h3><p>在系统中，新接收的消息并不等于未读消息。首页显示新接收到1条消息，但是总共的未读消息可能有3条。在数据库中的消息记录里面，会用<code>readFlag</code>和<code>lastFlag</code>分表标记未读消息和新接收消息。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206200053.png"></p>
<p>Emos小程序的index页面设有定时器，每5分钟发送一次轮询，查询接收到多少条新消息。MessageTask利用异步线程接收MQ中的消息，然后保存到message_ref集合中，并且设置新消息的lastFlag字段为true。</p>
<p>Service把message_ref中的某人所有的消息记录的lastFlag字段设置成false，返回的修改记录条数就相当于接收到了多少条新消息，这个结果要返回给小程序的。</p>
<h3 id="修改用户资料"><a href="#修改用户资料" class="headerlink" title="修改用户资料"></a>修改用户资料</h3><p>修改用户资料之后，Emos系统会自动向该员工发送消息通知。但是消息通知并不直接写入到MongoDB，而是写到MQ消息队列，然后在首页轮询的时候提示用户有新的系统消息。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206202953.png"></p>
<h1 id="RabbitMQ-入门"><a href="#RabbitMQ-入门" class="headerlink" title="RabbitMQ 入门"></a>RabbitMQ 入门</h1><h2 id="选用RabbitMQ"><a href="#选用RabbitMQ" class="headerlink" title="选用RabbitMQ"></a>选用RabbitMQ</h2><p>消息队列产品有很多，比如说常见的有RocketMQ、RabbitMQ、ActiveMQ和Kafka。其中Kafka的性能是最好的，并发量比较大，而且消息收发的速度也非常快。但是消息收发的可靠性上，Kafka不如RabbitMQ，而且技术选型的时候执行速度并不是唯一标准。</p>
<p>RabbitMQ还有另外一个杀手锏，那就是既支持消息异步收发，又支持同步收发。虽然我们现在大部分的场景对应的是消息异步收发，但是有的场合要支持消息的同步收发，这时候RabbitMQ能适应各种业务场景的优点就显现出来了。所以在项目立项的时候，选择RabbitMQ是最稳妥的方案。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206203312.png"></p>
<p><strong>安装RabbitMQ</strong></p>
<p>由于最后开发的Emos项目要发布到云主机上面，所以这里借助Docker环境，拉取一个RabbitMQ镜像，然后创建容器就可以使用RabbitMQ了。</p>
<p>把<code>rabbitmq.tar.gz</code>文件上传到CentOS系统，把镜像导入到Docker环境。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; rabbitmq.tar.gz</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206204620.png"></p>
<p>执行命令，创建<code>rabbitmq</code>容器，然后就可以使用<code>RabbitMQ</code>消息队列。留出两个端口：15672和5672</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it -d --name mq  -p 15672:15672 -p 5672:5672 rabbitmq</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206204725.png"></p>
<h2 id="RabbitMQ的五种队列模式"><a href="#RabbitMQ的五种队列模式" class="headerlink" title="RabbitMQ的五种队列模式"></a>RabbitMQ的五种队列模式</h2><p>能够应对更多的业务场景</p>
<ol>
<li><p>简单模式</p>
<p>一个生产者（发送方）对应一个消费者（接收方）</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206203633.png"></p>
</li>
<li><p>Work模式</p>
<p>一个生产者对应多个消费者，但是只能有一个消费者获得消息（排他）</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206203653.png"></p>
</li>
<li><p>发布/订阅模式</p>
<p>一个消费者将消息首先发送到fanout交换器，交换器绑定到多个队列，然后与之对应的所有消费者都能接收到消息（不排他）</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206203715.png"></p>
</li>
<li><p>路由模式</p>
<p>生产者将消息发送到direct交换器，交换器按照关键字（Key），把消息路由到某个队列</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206203738.png"></p>
</li>
<li><p>主题模式</p>
<p>生产者将消息发送到Topic交换器，交换器按照复杂的规则，把消息路由到某个队列</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206203801.png"></p>
</li>
</ol>
<h2 id="消息持久化"><a href="#消息持久化" class="headerlink" title="消息持久化"></a>消息持久化</h2><p>消息的可靠性是RabbitMQ的一大特色，RabbitMQ通过消息持久化来保证消息的可靠性。持久化可以防止在异常情况下丢失数据。除了消息能够持久化之外，甚至交换器和队列都能持久化。</p>
<h2 id="消息过期时间"><a href="#消息过期时间" class="headerlink" title="消息过期时间"></a>消息过期时间</h2><p>默认情况下，消息是无限期存储在RabbitMQ上面的，但是我们可以设置消息过期时间，到期之后无论该消息是否已经被接收，都会被RabbitMQ删除。</p>
<h2 id="Ack应答"><a href="#Ack应答" class="headerlink" title="Ack应答"></a>Ack应答</h2><p>消费者接收消息之后，必须返回一个Ack应答，那么RabbitMQ才会认为这条消息接收成功。如果想要删除这条消息，消费者发送Ack应答的时候，附带一个deliveryTag标志位即可。</p>
<h2 id="同步接收和异步接收"><a href="#同步接收和异步接收" class="headerlink" title="同步接收和异步接收"></a>同步接收和异步接收</h2><p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206205419.png"></p>
<p>异步收发创建消费者对象后，该对象就会一直挂载在后台运行，处于等待状态，以阻塞式的方式进行运行。</p>
<p>尽管异步接收消息消耗的系统资源较少，但是小程序和后端项目之间并不是长连接，所以后端项目异步方式接收到队列中的消息，也无法推送给移动端的小程序。因此可以让后端的Java项目采用同步的方式接收队列中的消息。在移动端，我们创建定时器，然后向后端Java项目发出轮询请求。后端Java项目接收到轮询请求之后，用同步方式接收队列中的消息，然后把消息存储在MongoDB上面，最后向小程序返回接收了多少条新消息，移动端则弹出提示框告知用户有信息的消息通知。</p>
<h1 id="消息模块数据模型设计"><a href="#消息模块数据模型设计" class="headerlink" title="消息模块数据模型设计"></a>消息模块数据模型设计</h1><h2 id="创建-POJO-映射类"><a href="#创建-POJO-映射类" class="headerlink" title="创建 POJO 映射类"></a>创建 POJO 映射类</h2><p>MongoDB中没有数据表的概念，而是采用集合（Collection）存储数据，每条数据就是一个文档（Document）。文档结构实际上就是常用的JSON，一个JSON就是一条记录。</p>
<h3 id="message集合"><a href="#message集合" class="headerlink" title="message集合"></a>message集合</h3><p>集合相当于MySQL中的数据表，但是没有固定的表结构。集合有什么字段，取决于保存在其中的数据。以下就是Message集合中JSON数据的结构要求，该集合负责记录所发送的消息的具体信息。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206212342.png"></p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206212402.png"></p>
<p>UUID 的用处：例如小程序每隔5分钟轮询是否有新的消息，如果积压的消息太多，Java系统没有接收完消息，这时候新的轮询到来，就会产生两个消费者共同接收同一个消息的情况，这会造成数据库中添加了重复的记录，如果每条MQ消息都有唯一的UUID值，第一个消费者把消息保存到数据库，那么第二个消费者就无法再把这条消息保存到数据库，解决了消息的重复消费问题。</p>
<p>创建<code>MessageEntity.java</code>类，映射<code>message</code>集合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">// 明确映射类关联的集合为 message</span></span><br><span class="line"><span class="meta">@Document(collation = &quot;message&quot;)</span></span><br><span class="line"><span class="comment">// 扩展序列化接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String _id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 唯一性约束</span></span><br><span class="line">    <span class="meta">@Indexed(unique = true)</span></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> Integer senderId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String senderPhoto = <span class="string">&quot;https://raw.githubusercontent.com/zodical416/picto/master/20220206213747.png&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String senderName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> Date sendTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="message-ref集合"><a href="#message-ref集合" class="headerlink" title="message_ref集合"></a>message_ref集合</h3><p>虽然<code>message</code>集合记录的是消息，并且里面有接受者ID，但是如果是群发消息，那么接受者ID是空值。这时候就需要用上<code>message_ref</code>集合来记录接收人和已读状态。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220206214111.png"></p>
<p>创建<code>MessageRefEntity.java</code>类，映射<code>message_ref</code>集合。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Document(collation = &quot;message_ref&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageRefEntity</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String _id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> String messageId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> Integer receiverId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> Boolean readFlag;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> Boolean lastFlag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="MongoDB-的联合查询"><a href="#MongoDB-的联合查询" class="headerlink" title="MongoDB 的联合查询"></a>MongoDB 的联合查询</h2><p>MongoDB从3.X开始支持集合的连接查询，也就相当于MySQL的表连接。我们先要向MongoDB中添加记录，于是message和message_ref两个集合就都创建出来了。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">db.message.insert( &#123;</span><br><span class="line">	_id: ObjectId(<span class="string">&quot;600bea9ab5bafb311f147506&quot;</span>),</span><br><span class="line">	uuid:<span class="string">&quot;bfcb7c47-5886-c528-5127-ce285bc2322a&quot;</span>,</span><br><span class="line">    senderId: <span class="number">0</span>,</span><br><span class="line">    senderPhoto: <span class="string">&quot;https://static-1258386385.cos.ap-beijing.myqcloud.com/img/System.jpg&quot;</span>,</span><br><span class="line">    senderName: <span class="string">&quot;Emos系统&quot;</span>,</span><br><span class="line">	msg: <span class="string">&quot;HelloWorld&quot;</span>,</span><br><span class="line">    sendTime: ISODate(<span class="string">&quot;2021-01-23T17:21:30Z&quot;</span>)</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.message_ref.insert( &#123;</span><br><span class="line">    _id: ObjectId(<span class="string">&quot;600beaf0d6310000830036f3&quot;</span>),</span><br><span class="line">    messageId: <span class="string">&quot;600bea9ab5bafb311f147506&quot;</span>,</span><br><span class="line">    receiverId: <span class="number">1</span>,</span><br><span class="line">    readFlag: <span class="literal">false</span>,</span><br><span class="line">	lastFlag: <span class="literal">true</span></span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>

<p>执行两个集合的联合查询，根据接收人来查询消息，并且按照消息发送时间降序排列，查询前50条记录</p>
<p>所采用的 <code>aggregate</code> 函数所传入的参数为一个数组，在进行连接之前，需要将 _id 对象转换为字符串。</p>
<p>将所查出的全部字段保存在一个引用字段中，字段名为 ref</p>
<p>match 语句后面为查询的条件，即接收方 Id 为 1</p>
<p>sort 语句对接收到的消息进行排序，意为按照查询时间进行降序排列</p>
<p>skip 与 limit 进行分页查询，从 0 开始向后取 50 条数据</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">db.message.aggregate([</span><br><span class="line">	&#123;</span><br><span class="line">		$set: &#123;</span><br><span class="line">			<span class="attr">&quot;id&quot;</span>: &#123; $toString: <span class="string">&quot;$_id&quot;</span> &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123;</span><br><span class="line">		$lookup:&#123;</span><br><span class="line">			from:<span class="string">&quot;message_ref&quot;</span>,</span><br><span class="line">			localField:<span class="string">&quot;id&quot;</span>,</span><br><span class="line">			foreignField:<span class="string">&quot;messageId&quot;</span>,</span><br><span class="line">			as:<span class="string">&quot;ref&quot;</span></span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">	&#123; $match:&#123;<span class="attr">&quot;ref.receiverId&quot;</span>: <span class="number">1</span>&#125; &#125;,</span><br><span class="line">	&#123; $sort: &#123;sendTime : <span class="number">-1</span>&#125; &#125;,</span><br><span class="line">	&#123; $skip: <span class="number">0</span> &#125;,</span><br><span class="line">	&#123; $limit: <span class="number">50</span> &#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>

<h1 id="设计消息模块的持久层"><a href="#设计消息模块的持久层" class="headerlink" title="设计消息模块的持久层"></a>设计消息模块的持久层</h1><h2 id="创建MessageDao类"><a href="#创建MessageDao类" class="headerlink" title="创建MessageDao类"></a>创建MessageDao类</h2><p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220207154636.png"></p>
<p>在<code>com.example.emos.wx.db.mapper</code>包中创建<code>MessageMapper.java</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">insert</span><span class="params">(MessageEntity entity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// entity 中保存的消息发送时间为北京时间，存入 Mongodb 会被当作格林尼治时间，需要先进行时间的转换</span></span><br><span class="line">        Date sendTime = entity.getSendTime();</span><br><span class="line">        sendTime = DateUtil.offset(sendTime, DateField.HOUR, <span class="number">8</span>);</span><br><span class="line">        entity.setSendTime(sendTime);</span><br><span class="line">        <span class="comment">// 数据保存至 mongodb</span></span><br><span class="line">        entity = mongoTemplate.save(entity);</span><br><span class="line">        <span class="keyword">return</span> entity.get_id();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 按照分页查询消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;HashMap&gt; <span class="title">searchMessageByPage</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">long</span> start, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 将 id 转换为字符串，并将其封装为 JSON 对象</span></span><br><span class="line">        JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        json.set(<span class="string">&quot;$toString&quot;</span>, <span class="string">&quot;$_id&quot;</span>);</span><br><span class="line">        <span class="comment">// 集合连接，创建对象，专门进行集合联合查询</span></span><br><span class="line">        Aggregation aggregation = Aggregation.newAggregation(</span><br><span class="line">                <span class="comment">// 将负责数据类型转换的 JSON 所得的变量保存，命名为 id</span></span><br><span class="line">                Aggregation.addFields().addField(<span class="string">&quot;id&quot;</span>).withValue(json).build(),</span><br><span class="line">                <span class="comment">// 进行集合联合查询，查询出的结果引用字段命名为 ref</span></span><br><span class="line">                Aggregation.lookup(<span class="string">&quot;message_ref&quot;</span>, <span class="string">&quot;id&quot;</span>, <span class="string">&quot;message_id&quot;</span>, <span class="string">&quot;ref&quot;</span>),</span><br><span class="line">                <span class="comment">// 查询发送给某个人的消息都有哪些</span></span><br><span class="line">                Aggregation.match(Criteria.where(<span class="string">&quot;ref.receiverId&quot;</span>).is(userId)),</span><br><span class="line">                <span class="comment">// 对数据按照发送时间进行降序排序</span></span><br><span class="line">                Aggregation.sort(Sort.by(Sort.Direction.DESC, <span class="string">&quot;sendTime&quot;</span>)),</span><br><span class="line">                Aggregation.skip(start),</span><br><span class="line">                Aggregation.limit(length)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">// 进行联合查询，并将查询结果保存</span></span><br><span class="line">        AggregationResults&lt;HashMap&gt; results = mongoTemplate.aggregate(aggregation, <span class="string">&quot;message&quot;</span>, HashMap.class);</span><br><span class="line">        <span class="comment">// 提取结果，并保存为 list</span></span><br><span class="line">        List&lt;HashMap&gt; list = results.getMappedResults();</span><br><span class="line">        <span class="comment">// 从 ref 中提取数据</span></span><br><span class="line">        list.forEach(one-&gt;&#123;</span><br><span class="line">            List&lt;MessageRefEntity&gt; refList = (List&lt;MessageRefEntity&gt;) one.get(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">            <span class="comment">// 提取出数据</span></span><br><span class="line">            MessageRefEntity entity = refList.get(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// 得到是否已读</span></span><br><span class="line">            <span class="keyword">boolean</span> readFlag = entity.getReadFlag();</span><br><span class="line">            String refId = entity.get_id();</span><br><span class="line">            one.put(<span class="string">&quot;readFlag&quot;</span>, readFlag);</span><br><span class="line">            one.put(<span class="string">&quot;refId&quot;</span>, refId);</span><br><span class="line">            <span class="comment">// 删除无用数据</span></span><br><span class="line">            one.remove(<span class="string">&quot;ref&quot;</span>);</span><br><span class="line">            one.remove(<span class="string">&quot;_id&quot;</span>);</span><br><span class="line">            <span class="comment">// 将格林尼治时间转回北京时间</span></span><br><span class="line">            Date sendTime = (Date) one.get(<span class="string">&quot;sendTime&quot;</span>);</span><br><span class="line">            sendTime = DateUtil.offset(sendTime, DateField.HOUR, -<span class="number">8</span>);</span><br><span class="line">            <span class="comment">// 将当前日期与 sendTime 进行比较，若是今天发出的，则显示时只显示时间，否则显示日期</span></span><br><span class="line">            String today = DateUtil.today();</span><br><span class="line">            <span class="keyword">if</span> (today.equals(DateUtil.date(sendTime).toDateStr())) &#123;</span><br><span class="line">                <span class="comment">// 若相等，则重新覆盖 sendtime，仅保存小时和分钟</span></span><br><span class="line">                one.put(<span class="string">&quot;sendTime&quot;</span>, DateUtil.format(sendTime, <span class="string">&quot;HH:mm&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 若不等，则仅保存日期</span></span><br><span class="line">                one.put(<span class="string">&quot;sendTime&quot;</span>, DateUtil.format(sendTime, <span class="string">&quot;yyyy/MM/dd&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 ID 查找数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashMap <span class="title">searchMessageById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        HashMap map = mongoTemplate.findById(id, HashMap.class, <span class="string">&quot;message&quot;</span>);</span><br><span class="line">        <span class="comment">// 将格林尼治时间转回北京时间</span></span><br><span class="line">        Date sendTime = (Date) map.get(<span class="string">&quot;sendTime&quot;</span>);</span><br><span class="line">        sendTime = DateUtil.offset(sendTime, DateField.HOUR, -<span class="number">8</span>);</span><br><span class="line">        <span class="comment">// 将日期对象变为字符串</span></span><br><span class="line">        map.replace(<span class="string">&quot;sendTime&quot;</span>, DateUtil.format(sendTime, <span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="创建MessageRefMapper类"><a href="#创建MessageRefMapper类" class="headerlink" title="创建MessageRefMapper类"></a>创建MessageRefMapper类</h1><p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220207163505.png"></p>
<p>在<code>com.example.emos.wx.db.mapper</code>包中创建<code>MessageRefMapper.java</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageRefMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">insert</span><span class="params">(MessageEntity entity)</span> </span>&#123;</span><br><span class="line">        entity = mongoTemplate.save(entity);</span><br><span class="line">        <span class="keyword">return</span> entity.get_id();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询未读消息的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">searchUnreadCount</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        Query query = <span class="keyword">new</span> Query();</span><br><span class="line">        <span class="comment">// 封装查询条件，要求在该ID下的未读消息</span></span><br><span class="line">        query.addCriteria(Criteria.where(<span class="string">&quot;readFlag&quot;</span>).is(<span class="keyword">false</span>).and(<span class="string">&quot;receiverId&quot;</span>).is(userId));</span><br><span class="line">        <span class="keyword">long</span> count = mongoTemplate.count(query, MessageRefEntity.class);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询新接收的消息数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">searchLastCount</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        Query query = <span class="keyword">new</span> Query();</span><br><span class="line">        query.addCriteria(Criteria.where(<span class="string">&quot;lastFlag&quot;</span>).is(<span class="keyword">true</span>).and(<span class="string">&quot;receiverId&quot;</span>).is(userId));</span><br><span class="line">        Update update = <span class="keyword">new</span> Update();</span><br><span class="line">        <span class="comment">// 将 lastflag 字段的值改为 false，代表不再是新消息</span></span><br><span class="line">        update.set(<span class="string">&quot;lastFlag&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// 修改集合中的数据，保存修改的记录的数量</span></span><br><span class="line">        UpdateResult result = mongoTemplate.updateMulti(query, update, <span class="string">&quot;message_ref&quot;</span>);</span><br><span class="line">        <span class="keyword">long</span> rows = result.getModifiedCount();</span><br><span class="line">        <span class="keyword">return</span> rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把未读消息变为已读</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">updateUnreadMessage</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        Query query = <span class="keyword">new</span> Query();</span><br><span class="line">        query.addCriteria(Criteria.where(<span class="string">&quot;_id&quot;</span>).is(id));</span><br><span class="line">        Update update = <span class="keyword">new</span> Update();</span><br><span class="line">        <span class="comment">// 将 lastflag 字段的值改为 false，代表不再是新消息</span></span><br><span class="line">        update.set(<span class="string">&quot;readFlag&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 修改集合中的数据，保存修改的记录的数量</span></span><br><span class="line">        <span class="comment">// 根据主键查找并修改数据，最多只能查找到一条数据，因此仅需修改一条</span></span><br><span class="line">        UpdateResult result = mongoTemplate.updateFirst(query, update, <span class="string">&quot;message_ref&quot;</span>);</span><br><span class="line">        <span class="keyword">long</span> rows = result.getModifiedCount();</span><br><span class="line">        <span class="keyword">return</span> rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据主键值删除消息记录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">deleteMessageRefById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        Query query = <span class="keyword">new</span> Query();</span><br><span class="line">        query.addCriteria(Criteria.where(<span class="string">&quot;_id&quot;</span>).is(id));</span><br><span class="line">        DeleteResult result = mongoTemplate.remove(query, <span class="string">&quot;message_ref&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取修改的记录数量</span></span><br><span class="line">        <span class="keyword">long</span> rows = result.getDeletedCount();</span><br><span class="line">        <span class="keyword">return</span> rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据主键值删除所有的用户消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">deleteUserMessageRef</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        Query query = <span class="keyword">new</span> Query();</span><br><span class="line">        query.addCriteria(Criteria.where(<span class="string">&quot;receiverId&quot;</span>).is(userId));</span><br><span class="line">        DeleteResult result = mongoTemplate.remove(query, <span class="string">&quot;message_ref&quot;</span>);</span><br><span class="line">        <span class="comment">// 获取修改的记录数量</span></span><br><span class="line">        <span class="keyword">long</span> rows = result.getDeletedCount();</span><br><span class="line">        <span class="keyword">return</span> rows;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="设计消息模块的业务层"><a href="#设计消息模块的业务层" class="headerlink" title="设计消息模块的业务层"></a>设计消息模块的业务层</h1><h2 id="定义Message业务接口"><a href="#定义Message业务接口" class="headerlink" title="定义Message业务接口"></a>定义Message业务接口</h2><p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220207172512.png"></p>
<p>创建<code>MessageService.java</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MessageService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">insertMessage</span><span class="params">(MessageEntity entity)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">insertRef</span><span class="params">(MessageRefEntity entity)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">searchUnreadCount</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">searchLastCount</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;HashMap&gt; <span class="title">searchMessageByPage</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">long</span> start, <span class="keyword">int</span> length)</span> </span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashMap <span class="title">searchMessageById</span><span class="params">(String id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">updateUnreadMessage</span><span class="params">(String id)</span> </span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">deleteMessageRefById</span><span class="params">(String id)</span></span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">deleteUserMessageRef</span><span class="params">(<span class="keyword">int</span> userId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义Message业务实现类"><a href="#定义Message业务实现类" class="headerlink" title="定义Message业务实现类"></a>定义Message业务实现类</h2><p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220207173523.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageServiceImpl</span> <span class="keyword">implements</span> <span class="title">MessageService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageMapper messageDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageRefMapper messageRefDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">insertMessage</span><span class="params">(MessageEntity entity)</span> </span>&#123;</span><br><span class="line">        String id = messageDao.insert(entity);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">insertRef</span><span class="params">(MessageRefEntity entity)</span> </span>&#123;</span><br><span class="line">        String id = messageRefDao.insert(entity);</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">searchUnreadCount</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> count = messageRefDao.searchUnreadCount(userId);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">searchLastCount</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> count = messageRefDao.searchLastCount(userId);</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;HashMap&gt; <span class="title">searchMessageByPage</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">long</span> start, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        List&lt;HashMap&gt; list = messageDao.searchMessageByPage(userId, start, length);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashMap <span class="title">searchMessageById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        HashMap map = messageDao.searchMessageById(id);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">updateUnreadMessage</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> rows = messageRefDao.updateUnreadMessage(id);</span><br><span class="line">        <span class="keyword">return</span> rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">deleteMessageRefById</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> rows = messageRefDao.deleteMessageRefById(id);</span><br><span class="line">        <span class="keyword">return</span> rows;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">deleteUserMessageRef</span><span class="params">(<span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> rows = messageRefDao.deleteUserMessageRef(userId);</span><br><span class="line">        <span class="keyword">return</span> rows;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="设计消息模块的-Web-层"><a href="#设计消息模块的-Web-层" class="headerlink" title="设计消息模块的 Web 层"></a>设计消息模块的 Web 层</h1><p>由于业务层的方法并非全部对移动端开放，因此在 Web 层不需要全部声明这九个方法。例如删除消息这一方法就不开放，仅仅是在删除用户时调用该方法删除该用户的所有消息。</p>
<h2 id="获取分页消息列表"><a href="#获取分页消息列表" class="headerlink" title="获取分页消息列表"></a>获取分页消息列表</h2><p>创建<code>SearchMessageByPageForm.java</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiModel</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchMessageByPageForm</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Min(1)</span></span><br><span class="line">    <span class="keyword">private</span> Integer page;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="meta">@Range(min = 1,max = 40)</span></span><br><span class="line">    <span class="keyword">private</span> Integer length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建<code>MessageController.java</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/message&quot;)</span> <span class="comment">// http 请求的访问路径</span></span><br><span class="line"><span class="meta">@Api(&quot;消息模块网络接口&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用于获取用户 id</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/searchMessageByPage&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;获取分页消息列表&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">searchMessageByPage</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> SearchMessageByPageForm form, <span class="meta">@RequestHeader(&quot;token&quot;)</span> String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> userId = jwtUtil.getUserId(token);</span><br><span class="line">        <span class="keyword">int</span> page = form.getPage();</span><br><span class="line">        <span class="keyword">int</span> length = form.getLength();</span><br><span class="line">        <span class="comment">// 计算偏移量，若为第一页，则偏移量为0，否则偏移量为之前的页码中所包含的消息数量</span></span><br><span class="line">        <span class="keyword">long</span> start = (page - <span class="number">1</span>) * length;</span><br><span class="line">        <span class="comment">// 查找结果</span></span><br><span class="line">        List&lt;HashMap&gt; list = messageService.searchMessageByPage(userId, start, length);</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;result&quot;</span>, list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="根据ID查询消息"><a href="#根据ID查询消息" class="headerlink" title="根据ID查询消息"></a>根据ID查询消息</h2><p>创建<code>SearchMessageByIdForm.java</code>类，接收 Ajax 提交的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchMessageByIdForm</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>MessageController.java</code>中编写Web方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/searchMessageById&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;根据ID获取消息&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">searchMessageById</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> SearchMessageByIdForm form)</span> </span>&#123;</span><br><span class="line">   HashMap map = messageService.searchMessageById(form.getId());</span><br><span class="line">   <span class="keyword">return</span> R.ok().put(<span class="string">&quot;result&quot;</span>, map);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="把未读消息更新成已读消息"><a href="#把未读消息更新成已读消息" class="headerlink" title="把未读消息更新成已读消息"></a>把未读消息更新成已读消息</h2><p>创建<code>UpdateUnreadMessageForm.java</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UpdateUnreadMessageForm</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写Web方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/updateUnreadMessage&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;未读消息更新成已读消息&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">updateUnreadMessage</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> UpdateUnreadMessageForm form)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">long</span> rows = messageService.updateUnreadMessage(form.getId());</span><br><span class="line">   <span class="keyword">return</span> R.ok().put(<span class="string">&quot;result&quot;</span>, rows == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="删除消息"><a href="#删除消息" class="headerlink" title="删除消息"></a>删除消息</h2><p>创建<code>DeleteMessageRefByIdForm.java</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeleteMessageRefByIdForm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotNull</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写Web方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/deleteMessageRefById&quot;)</span></span><br><span class="line"><span class="meta">@ApiOperation(&quot;删除消息&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">deleteMessageRefById</span><span class="params">(<span class="meta">@Valid</span> <span class="meta">@RequestBody</span> DeleteMessageRefByIdForm form)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">long</span> rows = messageService.deleteMessageRefById(form.getId());</span><br><span class="line">   <span class="comment">// 若删除一条记录，返回结果为 true</span></span><br><span class="line">   <span class="keyword">return</span> R.ok().put(<span class="string">&quot;result&quot;</span>, rows == <span class="number">1</span> ? <span class="keyword">true</span> : <span class="keyword">false</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="理由-RabbitMQ-实现消息投递削峰填谷"><a href="#理由-RabbitMQ-实现消息投递削峰填谷" class="headerlink" title="理由 RabbitMQ 实现消息投递削峰填谷"></a>理由 RabbitMQ 实现消息投递削峰填谷</h1><h2 id="异步和同步如何选择"><a href="#异步和同步如何选择" class="headerlink" title="异步和同步如何选择"></a>异步和同步如何选择</h2><p>收发消息模块采用异步执行，用户登录之后使一个线程挂载在后台继续执行，从而尽可能减少用户登录所需的时间。</p>
<p>RabbitMQ 提供了同步和异步两种收发消息的模型，若选择异步执行，则会创建一个消费者对象挂载在后台持续运行，该对象不会退出，当没有消息时仍然处于等待的状态。同时，该对象只会接收某一个用户的消息，假若有一万人登录该系统，则需要创建一万个消息对象，对于 Java 系统与虚拟机造成了巨大的压力。采用同步收发消息策略，消息收发完毕之后，所创建的消费者对象自动销毁，比异步收发效果更好。</p>
<p>因此采用了异步线程同步收发消息的方法。</p>
<h2 id="导入依赖库"><a href="#导入依赖库" class="headerlink" title="导入依赖库"></a>导入依赖库</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="创建RabbitMQ配置类"><a href="#创建RabbitMQ配置类" class="headerlink" title="创建RabbitMQ配置类"></a>创建RabbitMQ配置类</h2><p>采用同步收发消息，连接<code>RabbitMQ</code>需要用到<code>ConnectionFactory</code>，所以我们要自己创建好<code>ConnectionFactory</code>对象然后注册给Spring框架，这就需要我们创建<code>RabbitMQConfig</code>类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">getFactroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConnectionFactory factory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">        <span class="comment">// Linux 主机 ip 地址</span></span><br><span class="line">        factory.setHost(<span class="string">&quot;192.168.1.14&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建消息任务类"><a href="#创建消息任务类" class="headerlink" title="创建消息任务类"></a>创建消息任务类</h2><p>这次要创建的多线程任务类是用来收发 RabbitMQ 消息的，而且内部包含了同步执行和异步执行两种方式。</p>
<p>在 task 包中新建 <code>MessageTask.java</code> 类</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220208163915.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageTask</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConnectionFactory factory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic 每个消息自己的名字</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entity 所发送的消息实体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(String topic, MessageEntity entity)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 将所发送的消息存入 mongodb，返回所保存的 id</span></span><br><span class="line">        String id = messageService.insertMessage(entity);</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            <span class="comment">// 创建通道</span></span><br><span class="line">            Channel channel = connection.createChannel();</span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="comment">// 连接消息队列，需要传入消息队列名，true 表示消息队列持久化存储，false 表示不加锁，代表其他消费者也能连接到该消息队列上， false 不自动删除队列，null 表示无额外参数</span></span><br><span class="line">            channel.queueDeclare(topic, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 向消息队列中发的消息可能需要附属其他信息，需要写入请求头，可以利用 hashmap 写入</span></span><br><span class="line">            HashMap map = <span class="keyword">new</span> HashMap();</span><br><span class="line">            <span class="comment">// ref 中的消息需要确认会关联到哪一个消息主体上，通过 messageId 确定</span></span><br><span class="line">            map.put(<span class="string">&quot;messageId&quot;</span>, id);</span><br><span class="line">            <span class="comment">// 将 hashmap 写入请求头</span></span><br><span class="line">            AMQP.BasicProperties properties = <span class="keyword">new</span> AMQP.BasicProperties().builder().headers(map).build();</span><br><span class="line">            <span class="comment">// 发送消息</span></span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, topic, properties, entity.getMsg().getBytes());</span><br><span class="line">            <span class="comment">// 在日志中保留消息发送的提示文字</span></span><br><span class="line">            log.debug(<span class="string">&quot;消息发送成功&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 记录错误消息</span></span><br><span class="line">            log.error(<span class="string">&quot;执行异常&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EmosException(<span class="string">&quot;向 MQ 发送消息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步发送消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> entity</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendAsync</span><span class="params">(String topic, MessageEntity entity)</span> </span>&#123;</span><br><span class="line">        send(topic, entity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从消息队列接收消息，并将接收到的消息保存至 mongodb 的 ref 集合中</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">receive</span><span class="params">(String topic)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 记录接收到的消息数量</span></span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            <span class="comment">// 创建通道</span></span><br><span class="line">            Channel channel = connection.createChannel();</span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="comment">// 连接消息队列，需要传入消息队列名，true 表示消息队列持久化存储，false 表示不加锁，代表其他消费者也能连接到该消息队列上， false 不自动删除队列，null 表示无额外参数</span></span><br><span class="line">            channel.queueDeclare(topic, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="comment">// 接收数据，不自动返回 ACK 应答，返回响应</span></span><br><span class="line">                GetResponse response = channel.basicGet(topic, <span class="keyword">false</span>);</span><br><span class="line">                <span class="keyword">if</span>(response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 从响应中提取绑定的属性数据，消息正文等</span></span><br><span class="line">                    <span class="comment">// 提取绑定的属性数据</span></span><br><span class="line">                    AMQP.BasicProperties properties = response.getProps();</span><br><span class="line">                    <span class="comment">// 获取请求头</span></span><br><span class="line">                    Map&lt;String, Object&gt; map = properties.getHeaders();</span><br><span class="line">                    <span class="comment">// 获取消息 id</span></span><br><span class="line">                    String messageId = map.get(<span class="string">&quot;messageId&quot;</span>).toString();</span><br><span class="line">                    <span class="comment">// 获取消息正文</span></span><br><span class="line">                    <span class="keyword">byte</span>[] body = response.getBody();</span><br><span class="line">                    String message = <span class="keyword">new</span> String(body);</span><br><span class="line">                    log.debug(<span class="string">&quot;从 RabbitMQ 中接收的消息：&quot;</span> +message);</span><br><span class="line">                    <span class="comment">// 接受完消息，向 ref 集合中保存数据</span></span><br><span class="line">                    MessageRefEntity entity = <span class="keyword">new</span> MessageRefEntity();</span><br><span class="line">                    <span class="comment">// 向对象中封装数据</span></span><br><span class="line">                    entity.setMessageId(messageId);</span><br><span class="line">                    entity.setReceiverId(Integer.parseInt(topic));</span><br><span class="line">                    entity.setReadFlag(<span class="keyword">false</span>);</span><br><span class="line">                    entity.setLastFlag(<span class="keyword">true</span>);</span><br><span class="line">                    messageService.insertRef(entity);</span><br><span class="line">                    <span class="comment">// 返回 ACK 应答，队列接收到该应答后，得知消费者成功得到了消息，将消息在队列中删除</span></span><br><span class="line">                    <span class="keyword">long</span> deliveryTag = response.getEnvelope().getDeliveryTag();</span><br><span class="line">                    channel.basicAck(deliveryTag, <span class="keyword">false</span>);</span><br><span class="line">                    i++;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 无消息可接收，退出循环</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 记录错误消息</span></span><br><span class="line">            log.error(<span class="string">&quot;执行异常&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EmosException(<span class="string">&quot;向 MQ 发送消息失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步从消息队列接收消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">receiveAsync</span><span class="params">(String topic)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> receive(topic);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除消息队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteQueue</span><span class="params">(String topic)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> (</span><br><span class="line">            <span class="comment">// 创建连接</span></span><br><span class="line">            Connection connection = factory.newConnection();</span><br><span class="line">            <span class="comment">// 创建通道</span></span><br><span class="line">            Channel channel = connection.createChannel();</span><br><span class="line">        ) &#123;</span><br><span class="line">            channel.queueDelete(topic);</span><br><span class="line">            log.debug(<span class="string">&quot;消息队列成功删除&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// 记录错误消息</span></span><br><span class="line">            log.error(<span class="string">&quot;删除队列失败&quot;</span>, e);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EmosException(<span class="string">&quot;删除队列失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异步执行方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> topic</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Async</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteQueueAsync</span><span class="params">(String topic)</span> </span>&#123;</span><br><span class="line">        deleteQueue(topic);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="执行系统消息异步收发"><a href="#执行系统消息异步收发" class="headerlink" title="执行系统消息异步收发"></a>执行系统消息异步收发</h1><p>在已有的业务流程中调用消息模块，实现消息的收发。例如注册成功后、登录成功后以及首页定时轮询接收消息。</p>
<h2 id="注册流程中的消息发送"><a href="#注册流程中的消息发送" class="headerlink" title="注册流程中的消息发送"></a>注册流程中的消息发送</h2><p>用户注册流程中，当用户成功注册的时候，就可以利用<code>MessageTask</code>异步发送消息到MQ队列中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 持有消息变量</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageTask messageTask;</span><br><span class="line"><span class="comment">// 通知注册成功</span></span><br><span class="line">    MessageEntity entity = <span class="keyword">new</span> MessageEntity();</span><br><span class="line">    <span class="comment">// 系统对人发消息</span></span><br><span class="line">    entity.setSenderId(<span class="number">0</span>);</span><br><span class="line">    entity.setSenderName(<span class="string">&quot;系统消息&quot;</span>);</span><br><span class="line">    entity.setUuid(IdUtil.simpleUUID());</span><br><span class="line">    entity.setMsg(<span class="string">&quot;欢迎您注册成为超级管理员，请及时更新你的员工个人信息。&quot;</span>);</span><br><span class="line">    entity.setSendTime(<span class="keyword">new</span> Date());</span><br><span class="line">    <span class="comment">// 发送消息</span></span><br><span class="line">    messageTask.sendAsync(id + <span class="string">&quot;&quot;</span>, entity);</span><br></pre></td></tr></table></figure>

<p>重新注册超级管理员，mongoDb 中成功添加了一条消息记录：</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220209111826.png"></p>
<h2 id="登录流程中的消息接收"><a href="#登录流程中的消息接收" class="headerlink" title="登录流程中的消息接收"></a>登录流程中的消息接收</h2><p>在用户离线的过程中，Emos系统发送的消息通知是存放在MQ队列中的，所以用户登录之后就需要接收这些消息通知。该过程实际上就是让<code>MessageTask</code>异步接受MQ中的消息，然后存储在<code>message_ref</code>集合中。</p>
<p>在<code>UserServiceImpl.java</code>中，添加接收系统消息的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">login</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line">	……</span><br><span class="line">    messageTask.receiveAysnc(id+<span class="string">&quot;&quot;</span>);</span><br><span class="line">    ……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>登录系统之后，自动收到一条消息记录，添加在集合 message_ref 中：</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220209145528.png"></p>
<h2 id="轮询接收系统消息"><a href="#轮询接收系统消息" class="headerlink" title="轮询接收系统消息"></a>轮询接收系统消息</h2><p>在<code>MessageController.java</code>中，添加接收轮询消息的Web方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageController</span> </span>&#123;</span><br><span class="line">    ……</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/refreshMessage&quot;)</span></span><br><span class="line">    <span class="meta">@ApiOperation(&quot;刷新用户的消息&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> R <span class="title">refreshMessage</span><span class="params">(<span class="meta">@RequestHeader(&quot;token&quot;)</span> String token)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> userId = jwtUtil.getUserId(token);</span><br><span class="line">        <span class="comment">//异步接收消息</span></span><br><span class="line">        messageTask.receiveAysnc(userId + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">//查询接收了多少条消息</span></span><br><span class="line">        <span class="keyword">long</span> lastRows=messageService.searchLastCount(userId);</span><br><span class="line">        <span class="comment">//查询未读数据</span></span><br><span class="line">        <span class="keyword">long</span> unreadRows = messageService.searchUnreadCount(userId);</span><br><span class="line">        <span class="keyword">return</span> R.ok().put(<span class="string">&quot;lastRows&quot;</span>, lastRows).put(<span class="string">&quot;unreadRows&quot;</span>, unreadRows);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>main.js</code>文件中添加全局路径</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.url = &#123;</span><br><span class="line">	……</span><br><span class="line">	<span class="attr">refreshMessage</span>: baseUrl + <span class="string">&quot;/message/refreshMessage&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>index.vue</code>文件中引入气泡消息控件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uniPopup <span class="keyword">from</span> <span class="string">&#x27;@/components/uni-popup/uni-popup.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> uniPopupMessage <span class="keyword">from</span> <span class="string">&#x27;@/components/uni-popup/uni-popup-message.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> uniPopupDialog <span class="keyword">from</span> <span class="string">&#x27;@/components/uni-popup/uni-popup-dialog.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">	<span class="attr">components</span>: &#123;</span><br><span class="line">		uniPopup,</span><br><span class="line">		uniPopupMessage,</span><br><span class="line">		uniPopupDialog</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			<span class="attr">timer</span>: <span class="literal">null</span>,</span><br><span class="line">			<span class="attr">unreadRows</span>: <span class="number">0</span>,</span><br><span class="line">			<span class="attr">lastRows</span>: <span class="number">0</span></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">	……</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在页面上引入气泡消息标签</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;uni-popup ref=&quot;popupMsg&quot; type=&quot;top&quot;&gt;</span><br><span class="line">	&lt;uni-popup-message type=&quot;success&quot; :message=&quot;&#x27;接收到&#x27; + lastRows + &#x27;条消息&#x27;&quot; :duration=&quot;2000&quot;/&gt;</span><br><span class="line">&lt;/uni-popup&gt;</span><br></pre></td></tr></table></figure>

<p>编写JavaScript代码，执行消息轮询</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">onLoad:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="comment">// 监听事件</span></span><br><span class="line">	<span class="keyword">let</span> that = <span class="built_in">this</span>;</span><br><span class="line">	uni.$on(<span class="string">&#x27;showMessage&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		that.$refs.popupMsg.open();</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">onUnload</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="comment">// 移除监听事件</span></span><br><span class="line">	uni.$off(<span class="string">&#x27;showMessage&#x27;</span>);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">onShow</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> that = <span class="built_in">this</span>;</span><br><span class="line">	that.timer = <span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		that.ajax(that.url.refreshMessage, <span class="string">&#x27;GET&#x27;</span>, <span class="literal">null</span>, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">			that.unreadRows = resp.data.unreadRows;</span><br><span class="line">			that.lastRows = resp.data.lastRows;</span><br><span class="line">			<span class="keyword">if</span> (that.lastRows &gt; <span class="number">0</span>) &#123;</span><br><span class="line">				uni.$emit(<span class="string">&#x27;showMessage&#x27;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;, <span class="number">5</span> * <span class="number">1000</span>);</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">onHide</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">clearInterval</span>(<span class="built_in">this</span>.timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>初次完成注册之后，能够得到消息提示，如下图所示。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/2cb842b2d49c358fb9b68005ac65ccf.jpg"></p>
<h1 id="设计系统消息列表页面"><a href="#设计系统消息列表页面" class="headerlink" title="设计系统消息列表页面"></a>设计系统消息列表页面</h1><h2 id="生成大量消息数据"><a href="#生成大量消息数据" class="headerlink" title="生成大量消息数据"></a>生成大量消息数据</h2><p>为了方便后续的测试，需要利用在<code>EmosWxApiApplicationTests.java</code>类中提供的<code>contextLoads()</code>测试用例方法，可以把生成大量系统消息记录的代码写在其中，程序运行的时候这些消息记录就会写入到MongoDB里面。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmosWxApiApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>;i &lt;= <span class="number">100</span>;i++) &#123;</span><br><span class="line">            MessageEntity message = <span class="keyword">new</span> MessageEntity();</span><br><span class="line">            <span class="comment">// 设置具体的消息信息</span></span><br><span class="line">            message.setUuid(IdUtil.simpleUUID());</span><br><span class="line">            message.setSenderId(<span class="number">0</span>);</span><br><span class="line">            message.setSendTime(<span class="keyword">new</span> Date());</span><br><span class="line">            message.setSenderName(<span class="string">&quot;系统消息&quot;</span>);</span><br><span class="line">            message.setMsg(<span class="string">&quot;这是第&quot;</span> + i + <span class="string">&quot;条测试消息&quot;</span>);</span><br><span class="line">            String id = messageService.insertMessage(message);</span><br><span class="line"></span><br><span class="line">            MessageRefEntity ref = <span class="keyword">new</span> MessageRefEntity();</span><br><span class="line">            ref.setMessageId(id);</span><br><span class="line">            ref.setReceiverId(<span class="number">15</span>); <span class="comment">// 接收人id</span></span><br><span class="line">            ref.setLastFlag(<span class="keyword">true</span>);</span><br><span class="line">            ref.setReadFlag(<span class="keyword">false</span>);</span><br><span class="line">            messageService.insertRef(ref);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进入数据库中可以看到生成的消息列表</p>
<h2 id="引入列表控件"><a href="#引入列表控件" class="headerlink" title="引入列表控件"></a>引入列表控件</h2><p>创建<code>message_list</code>页面，然后引入列表控件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uniList from <span class="string">&#x27;@/components/uni-list/uni-list.vue&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> uniListItem from <span class="string">&#x27;@/components/uni-list-item/uni-list-item.vue&#x27;</span>;</span><br><span class="line">export <span class="keyword">default</span> &#123;</span><br><span class="line">	components: &#123;</span><br><span class="line">		uniList,</span><br><span class="line">		uniListItem</span><br><span class="line">	&#125;,</span><br><span class="line">	data() &#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			page: <span class="number">1</span>,</span><br><span class="line">			length: <span class="number">20</span>,</span><br><span class="line">			list: [</span><br><span class="line">				&#123;</span><br><span class="line">					id:<span class="string">&quot;601027486863f742e88b1b22&quot;</span>,</span><br><span class="line">					refId:<span class="string">&quot;6010274d6863f742e88b1b23&quot;</span>,</span><br><span class="line">					senderName:<span class="string">&quot;系统消息&quot;</span>,</span><br><span class="line">					senderPhoto:<span class="string">&quot;https://static-1258386385.cos.ap-beijing.myqcloud.com/img/System.jpg&quot;</span>,</span><br><span class="line">					msg:<span class="string">&quot;HelloWorld&quot;</span>,</span><br><span class="line">					readFlag:<span class="keyword">false</span>,</span><br><span class="line">					sendTime:<span class="string">&quot;2021-01-26 22:29:28&quot;</span></span><br><span class="line">				&#125;</span><br><span class="line">			],</span><br><span class="line">			isLastPage: <span class="keyword">false</span></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写视图层标签"><a href="#编写视图层标签" class="headerlink" title="编写视图层标签"></a>编写视图层标签</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;view <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;page&quot;</span>&gt;</span><br><span class="line">	<span class="xml"><span class="tag">&lt;<span class="name">uni-list</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">uni-list-chat</span> <span class="attr">v-for</span>=<span class="string">&quot;one in list&quot;</span> <span class="attr">:title</span>=<span class="string">&quot;one.senderName&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="xml">		  <span class="attr">:avatar</span>=<span class="string">&quot;one.senderPhoto&quot;</span> <span class="attr">:note</span>=<span class="string">&quot;one.msg&quot;</span> <span class="attr">badge-positon</span>=<span class="string">&quot;left&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="xml">		  <span class="attr">:badge-text</span>=<span class="string">&quot;one.readFlag ? &#x27;&#x27; : &#x27;dot&#x27;&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;one.id&quot;</span> <span class="attr">link</span>=<span class="string">&quot;navigateTo&quot;</span> </span></span></span><br><span class="line"><span class="tag"><span class="xml">		  <span class="attr">:to</span>=<span class="string">&quot;&#x27;../message/message?id=&#x27; + one.id + &#x27;&amp;readFlag=&#x27; + one.readFlag + &#x27;&amp;refId=&#x27; + one.refId&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;chat-custom-right&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">				<span class="tag">&lt;<span class="name">text</span> <span class="attr">class</span>=<span class="string">&quot;chat-custom-text&quot;</span>&gt;</span>&#123;&#123; one.sendTime &#125;&#125;<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span><br><span class="line"><span class="xml">			<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;/<span class="name">uni-list-chat</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">uni-list</span>&gt;</span></span></span><br><span class="line">&lt;/view&gt;</span><br></pre></td></tr></table></figure>

<h2 id="编写样式文件"><a href="#编写样式文件" class="headerlink" title="编写样式文件"></a>编写样式文件</h2><p>创建<code>message_list.less</code>文件，并引用该文件</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style lang=&quot;less&quot;&gt;</span><br><span class="line">	<span class="keyword">@import</span> url(<span class="string">&quot;message_list.less&quot;</span>);</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>内容为：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> url(<span class="string">&quot;../../style.less&quot;</span>);</span><br><span class="line"><span class="selector-class">.page</span>&#123;</span><br><span class="line">	<span class="attribute">padding</span>: <span class="number">0</span>rpx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.chat-custom-right</span>&#123;</span><br><span class="line">	<span class="attribute">position</span>: absolute;</span><br><span class="line">	<span class="attribute">right</span>: <span class="number">20</span>rpx;</span><br><span class="line">	<span class="selector-class">.chat-custom-text</span>&#123;</span><br><span class="line">		<span class="attribute">color</span>: <span class="number">#999</span>;</span><br><span class="line">		<span class="attribute">font-size</span>: <span class="number">24</span>rpx;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>页面如下：</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/14d530d1fe11968cffb4ee6e0dc3017.jpg"></p>
<h1 id="消息列表页面加载分页数据"><a href="#消息列表页面加载分页数据" class="headerlink" title="消息列表页面加载分页数据"></a>消息列表页面加载分页数据</h1><h2 id="封装查询分页数据函数"><a href="#封装查询分页数据函数" class="headerlink" title="封装查询分页数据函数"></a>封装查询分页数据函数</h2><p>之前已经把消息模块后端Java代码都封装好了，所以可以继续写前端代码，加载动态数据。由于进入页面和上拉触底加载分页数据，都需要发出Ajax请求，故此要把查询分页数据的代码给封装起来，后面调用的时候更加容易。</p>
<p>在<code>main.js</code>文件中定义全局URL</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.url = &#123;</span><br><span class="line">	……</span><br><span class="line">	<span class="attr">searchMessageByPage</span>: baseUrl + <span class="string">&quot;/message/searchMessageByPage&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义加载分页数据的<code>loadMessageList()</code>函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">loadMessageList: <span class="function"><span class="keyword">function</span>(<span class="params">ref</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> data = &#123;</span><br><span class="line">		<span class="attr">page</span>: ref.page,</span><br><span class="line">		<span class="attr">length</span>: ref.length</span><br><span class="line">	&#125;;</span><br><span class="line">	ref.ajax(ref.url.searchMessageByPage, <span class="string">&#x27;POST&#x27;</span>, data, <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">let</span> result = resp.data.result;</span><br><span class="line">		<span class="keyword">if</span> (result == <span class="literal">null</span> || result.length == <span class="number">0</span>) &#123;</span><br><span class="line">			ref.isLastPage = <span class="literal">true</span>;</span><br><span class="line">			ref.page = ref.page - <span class="number">1</span>;</span><br><span class="line">			uni.showToast(&#123;</span><br><span class="line">				<span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">				<span class="attr">title</span>: <span class="string">&#x27;已经到底了&#x27;</span></span><br><span class="line">			&#125;);</span><br><span class="line">		&#125; </span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> (ref.page == <span class="number">1</span>) &#123;</span><br><span class="line">				ref.list = [];</span><br><span class="line">			&#125;</span><br><span class="line">			ref.list = ref.list.concat(result);</span><br><span class="line">			<span class="keyword">if</span> (ref.page &gt; <span class="number">1</span>) &#123;</span><br><span class="line">				uni.showToast(&#123;</span><br><span class="line">					<span class="attr">icon</span>: <span class="string">&#x27;none&#x27;</span>,</span><br><span class="line">					<span class="attr">title</span>: <span class="string">&#x27;又加载了&#x27;</span> + result.length + <span class="string">&#x27;条消息&#x27;</span></span><br><span class="line">				&#125;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="加载分页数据"><a href="#加载分页数据" class="headerlink" title="加载分页数据"></a>加载分页数据</h2><p>声明onShow回调函数，显示页面的时候加载第一页数据</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">onShow: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">let</span> that = <span class="built_in">this</span>;</span><br><span class="line">	that.page = <span class="number">1</span>;</span><br><span class="line">	that.isLastPage = <span class="literal">false</span>;</span><br><span class="line">	uni.pageScrollTo(&#123;</span><br><span class="line">		<span class="attr">scrollTop</span>: <span class="string">&#x27;0&#x27;</span></span><br><span class="line">	&#125;);</span><br><span class="line">	<span class="built_in">this</span>.loadMessageList(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当用户上划页面触底之后，触发翻页事件的回调函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">onReachBottom: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.isLastPage) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">this</span>.page = <span class="built_in">this</span>.page + <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">this</span>.loadMessageList(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编写跳转代码"><a href="#编写跳转代码" class="headerlink" title="编写跳转代码"></a>编写跳转代码</h2><p>我们回到首页，添加跳转到消息列表页面的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;view <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;notify-container&quot;</span> @tap=<span class="string">&quot;toPage(&#x27;消息提醒&#x27;, &#x27;/pages/message_list/message_list&#x27;)&quot;</span>&gt;</span><br><span class="line">	……</span><br><span class="line">&lt;/view&gt;</span><br></pre></td></tr></table></figure>

<h1 id="实现系统消息页面"><a href="#实现系统消息页面" class="headerlink" title="实现系统消息页面"></a>实现系统消息页面</h1><p>在消息页面中，我们可以看到完整的消息正文之外，还能删除该消息。而且只要用户进入到消息页面，那么JS会自动发出Ajax请求，标记该消息为已读状态。</p>
<p><img src="https://raw.githubusercontent.com/zodical416/picto/master/20220215150524.png"></p>
<p>创建<code>message</code>页面和<code>less</code>文件，并且引用样式文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style lang=<span class="string">&quot;less&quot;</span>&gt;</span><br><span class="line">	@<span class="keyword">import</span> url(<span class="string">&quot;message.less&quot;</span>);</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>

<p>定义<code>message.vue</code>页面内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;view <span class="class"><span class="keyword">class</span></span>=<span class="string">&quot;message&quot;</span>&gt;</span><br><span class="line">	<span class="xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;header&quot;</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;desc&quot;</span>&gt;</span>&#123;&#123; sendTime &#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="xml">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;opt&quot;</span> @<span class="attr">tap</span>=<span class="string">&quot;deleteMsg&quot;</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line"><span class="xml">	<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line">	<span class="xml"><span class="tag">&lt;<span class="name">view</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span>&#123;&#123; msg &#125;&#125;<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span></span><br><span class="line">&lt;/view&gt;</span><br></pre></td></tr></table></figure>

<p>定义CSS样式</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> url(<span class="string">&quot;../../style.less&quot;</span>);</span><br><span class="line"><span class="selector-class">.message</span>&#123;</span><br><span class="line">	<span class="attribute">margin</span>: <span class="number">55</span>rpx;</span><br><span class="line">	<span class="selector-class">.header</span>&#123;</span><br><span class="line">		<span class="attribute">display</span>: flex;</span><br><span class="line">		<span class="attribute">justify-content</span>: space-between;</span><br><span class="line">		<span class="attribute">margin-bottom</span>: <span class="number">15</span>rpx;</span><br><span class="line">		<span class="selector-class">.desc</span>&#123;</span><br><span class="line">			<span class="attribute">font-size</span>: <span class="number">28</span>rpx;</span><br><span class="line">			<span class="attribute">color</span>: <span class="number">#999</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="selector-class">.opt</span>&#123;</span><br><span class="line">			<span class="attribute">font-size</span>: <span class="number">28</span>rpx;</span><br><span class="line">			<span class="attribute">color</span>: red;</span><br><span class="line">			<span class="attribute">padding-right</span>: <span class="number">10</span>rpx;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="selector-class">.content</span>&#123;</span><br><span class="line">		<span class="attribute">background-color</span>: <span class="number">#f5f5f5</span>;</span><br><span class="line">		<span class="attribute">font-size</span>: <span class="number">32</span>rpx;</span><br><span class="line">		<span class="attribute">padding</span>: <span class="number">20</span>rpx <span class="number">45</span>rpx;</span><br><span class="line">		<span class="attribute">line-height</span>: <span class="number">1.8</span>;</span><br><span class="line">		<span class="attribute">color</span>: @font-color;</span><br><span class="line">		<span class="attribute">border-radius</span>: <span class="number">15</span>rpx;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>main.js</code>文件中声明全局URL</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Vue.prototype.url = &#123;</span><br><span class="line">	……</span><br><span class="line">	<span class="attr">searchMessageById</span>: baseUrl + <span class="string">&quot;/message/searchMessageById&quot;</span>,</span><br><span class="line">	<span class="attr">updateUnreadMessage</span>: baseUrl + <span class="string">&quot;/message/updateUnreadMessage&quot;</span>,</span><br><span class="line">	<span class="attr">deleteMessageRefById</span>: baseUrl + <span class="string">&quot;/message/deleteMessageRefById&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义模型层代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">	<span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> &#123;</span><br><span class="line">			<span class="attr">id</span>: <span class="literal">null</span>,</span><br><span class="line">			<span class="attr">readFlag</span>: <span class="literal">null</span>,</span><br><span class="line">			<span class="attr">refId</span>: <span class="literal">null</span>,</span><br><span class="line">			<span class="attr">sendTime</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">			<span class="attr">msg</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="function"><span class="title">onShow</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">		<span class="keyword">let</span> that = <span class="built_in">this</span>;</span><br><span class="line">		uni.setNavigationBarTitle(&#123;</span><br><span class="line">			<span class="attr">title</span>: <span class="string">&#x27;系统通知&#x27;</span></span><br><span class="line">		&#125;);</span><br><span class="line">		that.ajax(that.url.searchMessageById,<span class="string">&quot;POST&quot;</span>,&#123;<span class="string">&quot;id&quot;</span>: that.id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">resp</span>)</span>&#123;</span><br><span class="line">			<span class="keyword">let</span> result = resp.data.result;</span><br><span class="line">			that.sendTime = result.sendTime;</span><br><span class="line">			that.msg = result.msg;</span><br><span class="line">		&#125;)</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">onLoad</span>: <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">		<span class="keyword">let</span> that = <span class="built_in">this</span>;</span><br><span class="line">		that.id = options.id;</span><br><span class="line">		that.readFlag = options.readFlag == <span class="string">&#x27;true&#x27;</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">		that.refId = options.refId;</span><br><span class="line">		<span class="keyword">if</span> (!that.readFlag) &#123;</span><br><span class="line">			that.ajax(that.url.updateUnreadMessage,<span class="string">&quot;POST&quot;</span>,&#123;<span class="string">&quot;id&quot;</span>: that.refId&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">				<span class="built_in">console</span>.log(<span class="string">&#x27;消息更新成已读状态&#x27;</span>);</span><br><span class="line">			&#125;)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">	<span class="attr">methods</span>: &#123;</span><br><span class="line">		<span class="attr">deleteMsg</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">let</span> that = <span class="built_in">this</span>;</span><br><span class="line">			uni.showModal(&#123;</span><br><span class="line">				<span class="attr">title</span>: <span class="string">&#x27;提示信息&#x27;</span>,</span><br><span class="line">				<span class="attr">content</span>: <span class="string">&#x27;是否要删除这条消息？&#x27;</span>,</span><br><span class="line">				<span class="attr">success</span>: <span class="function"><span class="keyword">function</span>(<span class="params">resp</span>) </span>&#123;</span><br><span class="line">					<span class="keyword">if</span> (resp.confirm) &#123;</span><br><span class="line">						that.ajax(that.url.deleteMessageRefById,<span class="string">&quot;POST&quot;</span>,&#123;<span class="string">&quot;id&quot;</span>: that.refId&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">resp</span>)</span>&#123;</span><br><span class="line">							uni.showToast(&#123;</span><br><span class="line">								<span class="attr">icon</span>:<span class="string">&quot;success&quot;</span>,</span><br><span class="line">								<span class="attr">title</span>:<span class="string">&quot;删除成功&quot;</span>,</span><br><span class="line">								<span class="attr">complete</span>:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">									<span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">										uni.navigateBack(&#123;</span><br><span class="line">											<span class="attr">delta</span>: <span class="number">1</span></span><br><span class="line">										&#125;);</span><br><span class="line">									&#125;,<span class="number">1000</span>)</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;)</span><br><span class="line">						&#125;)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
      
      <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>
      
    </div>


    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" rel="tag"># 项目实战</a>
              <a href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/" rel="tag"># 小程序</a>
              <a href="/tags/Spring-Boot/" rel="tag"># Spring Boot</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/02/14/RabbitMQ%20%E5%9F%BA%E7%A1%80/" rel="prev" title="Rabbit MQ 基础">
      <i class="fa fa-chevron-left"></i> Rabbit MQ 基础
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/02/15/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/" rel="next" title="计算机网络基础">
      计算机网络基础 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%80%9A%E7%9F%A5%E6%A8%A1%E5%9D%97%E5%9F%BA%E6%9C%AC%E8%AE%BE%E8%AE%A1%E5%8E%9F%E7%90%86"><span class="nav-number">1.</span> <span class="nav-text">消息通知模块基本设计原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1"><span class="nav-number">1.1.</span> <span class="nav-text">数据库设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%91%E9%80%81%E4%B8%8E%E6%94%B6%E5%8F%96"><span class="nav-number">1.2.</span> <span class="nav-text">系统消息的发送与收取</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%9A%E5%8A%A1%E8%AF%B4%E6%98%8E"><span class="nav-number">1.3.</span> <span class="nav-text">业务说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E7%99%BB%E5%BD%95"><span class="nav-number">1.3.1.</span> <span class="nav-text">系统登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A6%96%E9%A1%B5%E5%AE%9A%E6%97%B6%E8%BD%AE%E8%AF%A2"><span class="nav-number">1.3.2.</span> <span class="nav-text">首页定时轮询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7%E8%B5%84%E6%96%99"><span class="nav-number">1.3.3.</span> <span class="nav-text">修改用户资料</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RabbitMQ-%E5%85%A5%E9%97%A8"><span class="nav-number">2.</span> <span class="nav-text">RabbitMQ 入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%89%E7%94%A8RabbitMQ"><span class="nav-number">2.1.</span> <span class="nav-text">选用RabbitMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RabbitMQ%E7%9A%84%E4%BA%94%E7%A7%8D%E9%98%9F%E5%88%97%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.2.</span> <span class="nav-text">RabbitMQ的五种队列模式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">2.3.</span> <span class="nav-text">消息持久化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4"><span class="nav-number">2.4.</span> <span class="nav-text">消息过期时间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ack%E5%BA%94%E7%AD%94"><span class="nav-number">2.5.</span> <span class="nav-text">Ack应答</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E6%8E%A5%E6%94%B6%E5%92%8C%E5%BC%82%E6%AD%A5%E6%8E%A5%E6%94%B6"><span class="nav-number">2.6.</span> <span class="nav-text">同步接收和异步接收</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="nav-number">3.</span> <span class="nav-text">消息模块数据模型设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA-POJO-%E6%98%A0%E5%B0%84%E7%B1%BB"><span class="nav-number">3.1.</span> <span class="nav-text">创建 POJO 映射类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#message%E9%9B%86%E5%90%88"><span class="nav-number">3.1.1.</span> <span class="nav-text">message集合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#message-ref%E9%9B%86%E5%90%88"><span class="nav-number">3.1.2.</span> <span class="nav-text">message_ref集合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MongoDB-%E7%9A%84%E8%81%94%E5%90%88%E6%9F%A5%E8%AF%A2"><span class="nav-number">3.2.</span> <span class="nav-text">MongoDB 的联合查询</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97%E7%9A%84%E6%8C%81%E4%B9%85%E5%B1%82"><span class="nav-number">4.</span> <span class="nav-text">设计消息模块的持久层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAMessageDao%E7%B1%BB"><span class="nav-number">4.1.</span> <span class="nav-text">创建MessageDao类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAMessageRefMapper%E7%B1%BB"><span class="nav-number">5.</span> <span class="nav-text">创建MessageRefMapper类</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97%E7%9A%84%E4%B8%9A%E5%8A%A1%E5%B1%82"><span class="nav-number">6.</span> <span class="nav-text">设计消息模块的业务层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89Message%E4%B8%9A%E5%8A%A1%E6%8E%A5%E5%8F%A3"><span class="nav-number">6.1.</span> <span class="nav-text">定义Message业务接口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9A%E4%B9%89Message%E4%B8%9A%E5%8A%A1%E5%AE%9E%E7%8E%B0%E7%B1%BB"><span class="nav-number">6.2.</span> <span class="nav-text">定义Message业务实现类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E6%B6%88%E6%81%AF%E6%A8%A1%E5%9D%97%E7%9A%84-Web-%E5%B1%82"><span class="nav-number">7.</span> <span class="nav-text">设计消息模块的 Web 层</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%88%86%E9%A1%B5%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8"><span class="nav-number">7.1.</span> <span class="nav-text">获取分页消息列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B9%E6%8D%AEID%E6%9F%A5%E8%AF%A2%E6%B6%88%E6%81%AF"><span class="nav-number">7.2.</span> <span class="nav-text">根据ID查询消息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%8A%E6%9C%AA%E8%AF%BB%E6%B6%88%E6%81%AF%E6%9B%B4%E6%96%B0%E6%88%90%E5%B7%B2%E8%AF%BB%E6%B6%88%E6%81%AF"><span class="nav-number">7.3.</span> <span class="nav-text">把未读消息更新成已读消息</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%B6%88%E6%81%AF"><span class="nav-number">7.4.</span> <span class="nav-text">删除消息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%90%86%E7%94%B1-RabbitMQ-%E5%AE%9E%E7%8E%B0%E6%B6%88%E6%81%AF%E6%8A%95%E9%80%92%E5%89%8A%E5%B3%B0%E5%A1%AB%E8%B0%B7"><span class="nav-number">8.</span> <span class="nav-text">理由 RabbitMQ 实现消息投递削峰填谷</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E5%92%8C%E5%90%8C%E6%AD%A5%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9"><span class="nav-number">8.1.</span> <span class="nav-text">异步和同步如何选择</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5%E4%BE%9D%E8%B5%96%E5%BA%93"><span class="nav-number">8.2.</span> <span class="nav-text">导入依赖库</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BARabbitMQ%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-number">8.3.</span> <span class="nav-text">创建RabbitMQ配置类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9B%E5%BB%BA%E6%B6%88%E6%81%AF%E4%BB%BB%E5%8A%A1%E7%B1%BB"><span class="nav-number">8.4.</span> <span class="nav-text">创建消息任务类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%E5%BC%82%E6%AD%A5%E6%94%B6%E5%8F%91"><span class="nav-number">9.</span> <span class="nav-text">执行系统消息异步收发</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81"><span class="nav-number">9.1.</span> <span class="nav-text">注册流程中的消息发送</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E4%B8%AD%E7%9A%84%E6%B6%88%E6%81%AF%E6%8E%A5%E6%94%B6"><span class="nav-number">9.2.</span> <span class="nav-text">登录流程中的消息接收</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AE%E8%AF%A2%E6%8E%A5%E6%94%B6%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF"><span class="nav-number">9.3.</span> <span class="nav-text">轮询接收系统消息</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AE%BE%E8%AE%A1%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8%E9%A1%B5%E9%9D%A2"><span class="nav-number">10.</span> <span class="nav-text">设计系统消息列表页面</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E5%A4%A7%E9%87%8F%E6%B6%88%E6%81%AF%E6%95%B0%E6%8D%AE"><span class="nav-number">10.1.</span> <span class="nav-text">生成大量消息数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E5%85%A5%E5%88%97%E8%A1%A8%E6%8E%A7%E4%BB%B6"><span class="nav-number">10.2.</span> <span class="nav-text">引入列表控件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E8%A7%86%E5%9B%BE%E5%B1%82%E6%A0%87%E7%AD%BE"><span class="nav-number">10.3.</span> <span class="nav-text">编写视图层标签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E6%A0%B7%E5%BC%8F%E6%96%87%E4%BB%B6"><span class="nav-number">10.4.</span> <span class="nav-text">编写样式文件</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%88%97%E8%A1%A8%E9%A1%B5%E9%9D%A2%E5%8A%A0%E8%BD%BD%E5%88%86%E9%A1%B5%E6%95%B0%E6%8D%AE"><span class="nav-number">11.</span> <span class="nav-text">消息列表页面加载分页数据</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%81%E8%A3%85%E6%9F%A5%E8%AF%A2%E5%88%86%E9%A1%B5%E6%95%B0%E6%8D%AE%E5%87%BD%E6%95%B0"><span class="nav-number">11.1.</span> <span class="nav-text">封装查询分页数据函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E5%88%86%E9%A1%B5%E6%95%B0%E6%8D%AE"><span class="nav-number">11.2.</span> <span class="nav-text">加载分页数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E8%B7%B3%E8%BD%AC%E4%BB%A3%E7%A0%81"><span class="nav-number">11.3.</span> <span class="nav-text">编写跳转代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E7%B3%BB%E7%BB%9F%E6%B6%88%E6%81%AF%E9%A1%B5%E9%9D%A2"><span class="nav-number">12.</span> <span class="nav-text">实现系统消息页面</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zodiacal</p>
  <div class="site-description" itemprop="description">引出魔鬼的一种试炼</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">47</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">17</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zodiacal</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">481k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">7:18</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
